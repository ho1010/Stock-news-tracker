<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¯¸êµ­ ì£¼ì‹ ì‹¤ì‹œê°„ ë‰´ìŠ¤ íŠ¸ë˜ì»¤</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      text-align: center;
    }

    .header h1 {
      font-size: 1.8em;
      margin-bottom: 6px;
    }

    .header p {
      font-size: 0.95em;
      opacity: 0.9;
    }

    .controls {
      display: flex;
      gap: 10px;
      padding: 10px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 12px 40px 12px 15px;
      border: 2px solid #dee2e6;
      border-radius: 10px;
      font-size: 1em;
      transition: all 0.3s;
    }

    .search-box input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }

    select {
      padding: 12px 15px;
      border: 2px solid #dee2e6;
      border-radius: 10px;
      font-size: 1em;
      background: white;
      cursor: pointer;
      min-width: 180px;
    }

    select:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-ghost {
      background: transparent;
      color: #667eea;
      border: 2px solid #dee2e6;
    }

    .btn-ghost:hover {
      background: #eef2ff;
      border-color: #667eea;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      padding: 10px 20px;
      background: #f8f9fa;
    }

    .stat-card {
      background: white;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-card .label {
      color: #6c757d;
      font-size: 0.9em;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 1.4em;
      font-weight: bold;
      color: #667eea;
    }

    .desktop-only {
      display: block;
    }

    @media (max-width: 768px) {
      .desktop-only {
        display: none !important;
      }
    }

    .content {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 0;
      min-height: 0;
    }

    .sidebar {
      background: #f8f9fa;
      border-right: 1px solid #dee2e6;
      padding: 12px;
      overflow-y: visible;
      max-height: none;
    }

    .sector-list {
      list-style: none;
    }

    .sector-item {
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sector-item:hover {
      background: #e9ecef;
    }

    .sector-item.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }

    .sector-count {
      background: rgba(0,0,0,0.1);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.85em;
    }

    .news-container {
      padding: 12px 16px;
      overflow-y: auto;
      max-height: 480px; /* ìµœì‹  ë‰´ìŠ¤ ì°½ ë†’ì´ ì¶•ì†Œ */
    }

    .news-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #dee2e6;
    }

    .news-header h2 {
      color: #333;
      font-size: 1.4em;
    }

    .refresh-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      cursor: pointer;
      color: #667eea;
      transition: transform 0.3s;
    }

    .refresh-btn:hover {
      transform: rotate(180deg);
    }

    .news-grid {
      display: grid;
      gap: 16px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: white;
      width: 90%;
      max-width: 520px;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      overflow: hidden;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    /* ì¢…ëª© ê´€ë¦¬ ëª¨ë‹¬ ì „ìš© ìŠ¤íƒ€ì¼ */
    .modal.manage-modal {
      max-width: 900px;
      width: 95%;
    }

    .modal-header {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .modal-header h3 {
      font-size: 1.5em;
      margin: 0;
    }

    .modal-body {
      padding: 16px;
      display: grid;
      gap: 12px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }

    .manage-modal .modal-body {
      padding: 24px;
      gap: 20px;
    }

    .modal-footer {
      padding: 12px 16px;
      background: #f8f9fa;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      border-top: 1px solid #eee;
      flex-shrink: 0;
    }

    .manage-modal .modal-footer {
      padding: 16px 24px;
    }

    .form-row {
      display: grid;
      gap: 6px;
    }

    .checkbox-row {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: center;
    }

    .hint {
      color: #6c757d;
      font-size: 0.85em;
    }

    .news-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .news-card:hover {
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      transform: translateY(-3px);
      border-color: #667eea;
    }

    .news-meta {
      display: flex;
      gap: 15px;
      margin-bottom: 12px;
      font-size: 0.9em;
      color: #6c757d;
      flex-wrap: wrap;
    }

    .news-ticker {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
    }

    .news-time {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .news-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .news-summary {
      color: #666;
      line-height: 1.7;
      margin-bottom: 15px;
      font-size: 0.95em;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .news-content {
      color: #555;
      line-height: 1.8;
      margin-top: 15px;
      margin-bottom: 15px;
      font-size: 0.95em;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 3px solid #667eea;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .news-content-toggle {
      color: #667eea;
      cursor: pointer;
      font-size: 0.9em;
      margin-top: 10px;
      display: inline-block;
      font-weight: 600;
      text-decoration: underline;
    }

    .news-content-toggle:hover {
      color: #764ba2;
    }

    .news-source {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid #e9ecef;
    }

    .source-name {
      color: #667eea;
      font-weight: 600;
    }

    .read-more {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .read-more:hover {
      text-decoration: underline;
    }

    .loading {
      text-align: center;
      padding: 50px;
      color: #6c757d;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .no-news {
      text-align: center;
      padding: 50px;
      color: #6c757d;
    }

    .no-news-icon {
      font-size: 4em;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    .filter-tags {
      display: flex;
      gap: 10px;
      padding: 0 30px 20px;
      flex-wrap: wrap;
    }

    .filter-tag {
      background: #e9ecef;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-tag .remove {
      cursor: pointer;
      font-weight: bold;
      color: #dc3545;
    }

    /* ëª¨ë°”ì¼ ê°„ì†Œí™” ìŠ¤íƒ€ì¼ */
    .mobile-simplified {
      display: none;
    }

    .sector-chips {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
      flex-wrap: wrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .sector-chip {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
      border: 2px solid #dee2e6;
      background: white;
      color: #495057;
    }

    /* ëª¨ë°”ì¼ìš© ì„¹í„° ì¹© ê·¸ë¦¬ë“œ */
    @media (max-width: 768px) {
      .sector-chips {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
        padding: 10px 12px;
        max-height: none;
        overflow: visible;
      }

      .sector-chip {
        padding: 6px 10px;
        font-size: 0.75em;
        text-align: center;
        white-space: normal;
        word-break: break-word;
        min-height: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .sector-chip .count {
        margin-left: 0;
        margin-top: 2px;
        font-size: 0.8em;
      }
    }

    .sector-chip:hover {
      border-color: #667eea;
      background: #eef2ff;
    }

    .sector-chip.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }

    .sector-chip .count {
      margin-left: 6px;
      font-size: 0.85em;
      opacity: 0.8;
    }

    @media (max-width: 768px) {
      /* ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´ë“œë°” ìˆ¨ê¸°ê¸° */
      .sidebar {
        display: none !important;
      }

      .content {
        grid-template-columns: 1fr;
      }

      /* í—¤ë” ê°„ì†Œí™” */
      .header h1 {
        font-size: 1.4em;
      }

      .header p {
        display: none;
      }

      /* ì»¨íŠ¸ë¡¤ ê°„ì†Œí™” */
      .controls {
        display: grid;
        grid-template-columns: 1fr;
        padding: 10px 12px;
        gap: 8px;
      }

      /* ê²€ìƒ‰ ë°•ìŠ¤ */
      .controls > .search-box {
        order: 1;
        width: 100%;
        min-width: auto;
      }

      /* ê²€ìƒ‰, ì•Œë¦¼, ì¢…ëª©ê´€ë¦¬ë¥¼ í•œ ì¤„ì— ë°°ì¹˜ */
      .mobile-buttons-row {
        order: 2;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 6px;
      }

      .mobile-buttons-row .btn {
        width: 100%;
        padding: 10px 6px;
        font-size: 0.8em;
        white-space: nowrap;
      }

      .mobile-buttons-row .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      /* ë°ìŠ¤í¬í†±ìš© ì•Œë¦¼/ì¢…ëª©ê´€ë¦¬ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
      .controls > .btn-ghost.desktop-only {
        display: none !important;
      }

      /* ë°ìŠ¤í¬í†±ìš© ê²€ìƒ‰ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
      .controls > .btn-primary.desktop-only {
        display: none !important;
      }

      /* ì„¹í„° ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸° (ì¹©ìœ¼ë¡œ ëŒ€ì²´) */
      #sectorFilter {
        display: none;
      }

      /* ì‹œê°„ í•„í„° ìˆ¨ê¸°ê¸° */
      #timeFilter {
        display: none;
      }

      /* ì´ˆê¸°í™” ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
      .controls .btn-secondary {
        display: none;
      }

      /* ì•Œë¦¼/ì¢…ëª© ê´€ë¦¬ ë²„íŠ¼ ì‘ê²Œ */
      .btn-ghost {
        padding: 10px 16px;
        font-size: 0.9em;
      }

      /* í†µê³„ ì¹´ë“œ ê°„ì†Œí™” (2ê°œë§Œ í‘œì‹œ, ë†’ì´ ì¶•ì†Œ) */
      .stats {
        grid-template-columns: repeat(2, 1fr);
        padding: 6px 10px;
        gap: 6px;
      }

      .stat-card {
        padding: 6px 8px;
        min-height: auto;
      }

      .stat-card .label {
        font-size: 0.75em;
        margin-bottom: 4px;
      }

      .stat-card .value {
        font-size: 1em;
        line-height: 1.2;
      }


      /* ë‰´ìŠ¤ ì»¨í…Œì´ë„ˆ íŒ¨ë”© ì¡°ì • */
      .news-container {
        padding: 12px;
      }

      /* ë‰´ìŠ¤ ì¹´ë“œ ê°„ì†Œí™” */
      .news-card {
        padding: 16px;
      }

      .news-title {
        font-size: 1.1em;
      }

      .news-summary {
        font-size: 0.9em;
        -webkit-line-clamp: 2;
      }

      /* ì¢…ëª© ê´€ë¦¬ ëª¨ë‹¬ ëª¨ë°”ì¼ ë°˜ì‘í˜• */
      .manage-modal {
        width: 98% !important;
        max-width: 98% !important;
        max-height: 95vh !important;
      }

      .manage-modal .modal-body {
        padding: 16px !important;
        gap: 16px !important;
      }

      /* ì²« ë²ˆì§¸ ì¤„ ê°€ë¡œ ë°°ì¹˜ë¥¼ ëª¨ë°”ì¼ì—ì„œ ì„¸ë¡œë¡œ ë³€ê²½ */
      .manage-modal .modal-body > div[style*="grid-template-columns: 200px"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }

      .manage-modal #manageList {
        max-height: 300px !important;
      }
      
      /* í˜„ì¬ ì„¹í„° ì¢…ëª© ê·¸ë¦¬ë“œ ëª¨ë°”ì¼ ë°˜ì‘í˜• */
      .manage-modal #currentStocksList {
        grid-template-columns: repeat(2, 1fr) !important;
        overflow: visible !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ë¯¸êµ­ ì£¼ì‹ ì‹¤ì‹œê°„ ë‰´ìŠ¤</h1>
    </div>

    <div class="controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ì¢…ëª©ëª… ë˜ëŠ” í‹°ì»¤ë¡œ ê²€ìƒ‰... (ì˜ˆ: NVIDIA, TSLA)">
        <span class="search-icon">ğŸ”</span>
      </div>
      
      <select id="sectorFilter" class="desktop-only">
        <option value="all">ì „ì²´ ì„¹í„°</option>
      </select>

      <select id="timeFilter" class="desktop-only">
        <option value="today">ì˜¤ëŠ˜</option>
        <option value="week">ì´ë²ˆ ì£¼</option>
        <option value="month">ì´ë²ˆ ë‹¬</option>
        <option value="all">ì „ì²´</option>
      </select>

      <button class="btn btn-primary desktop-only" onclick="searchNews()">
        ğŸ” ê²€ìƒ‰
      </button>

      <button class="btn btn-secondary desktop-only" onclick="resetFilters()">
        ğŸ”„ ì´ˆê¸°í™”
      </button>

      <div class="mobile-buttons-row">
        <button class="btn btn-primary" onclick="searchNews()">
          ğŸ” ê²€ìƒ‰
        </button>
        <button class="btn btn-ghost" onclick="openNotifications()" title="ì•Œë¦¼ ì„¤ì •">
          ğŸ”” ì•Œë¦¼
        </button>
        <button class="btn btn-ghost" onclick="openManageStocks()" title="ì¢…ëª© ì¶”ê°€/ì‚­ì œ">
          ğŸ›  ì¢…ëª© ê´€ë¦¬
        </button>
      </div>

      <button class="btn btn-ghost desktop-only" onclick="openNotifications()" title="ì•Œë¦¼ ì„¤ì •">
        ğŸ”” ì•Œë¦¼
      </button>

      <button class="btn btn-ghost desktop-only" onclick="openManageStocks()" title="ì¢…ëª© ì¶”ê°€/ì‚­ì œ">
        ğŸ›  ì¢…ëª© ê´€ë¦¬
      </button>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="label">ì´ ì¶”ì  ì¢…ëª©</div>
        <div class="value" id="totalStocks">420</div>
      </div>
      <div class="stat-card">
        <div class="label">ì˜¤ëŠ˜ ë‰´ìŠ¤</div>
        <div class="value" id="todayNews">0</div>
      </div>
      <div class="stat-card desktop-only">
        <div class="label">ê¸ˆì¼ ë‰´ìŠ¤ ë§ì€ ì„¹í„°</div>
        <div class="value" id="topSector" style="font-size: 0.9em;">-</div>
      </div>
      <div class="stat-card desktop-only">
        <div class="label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
        <div class="value" style="font-size: 1em;" id="lastUpdate">-</div>
      </div>
    </div>

    <div class="filter-tags" id="filterTags"></div>

    <!-- ëª¨ë°”ì¼ìš© ì„¹í„° ì¹© -->
    <div class="sector-chips" id="sectorChips"></div>

    <div class="content">
      <div class="sidebar">
        <ul class="sector-list" id="sectorList"></ul>
      </div>

      <div class="news-container">
        <div class="news-header">
          <h2 id="newsTitle">ìµœì‹  ë‰´ìŠ¤</h2>
          <button class="refresh-btn" onclick="refreshNews()" title="ìƒˆë¡œê³ ì¹¨">âŸ³</button>
        </div>
        <div class="news-grid" id="newsGrid">
          <div class="loading">
            <div class="spinner"></div>
            <p>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ì•Œë¦¼ ì„¤ì • ëª¨ë‹¬ -->
  <div id="notifBackdrop" class="modal-backdrop" onclick="backdropClick(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="notifTitle" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="notifTitle">ğŸ”” ì•Œë¦¼ ì„¤ì •</h3>
        <button class="btn btn-ghost" onclick="closeNotifications()">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label><strong>ì•Œë¦¼ í™œì„±í™”</strong></label>
          <div class="checkbox-row">
            <label><input type="checkbox" id="notifEnabled"> í™œì„±í™”</label>
            <span class="hint" id="notifPermHint"></span>
          </div>
        </div>

        <div class="form-row">
          <label><strong>ì•Œë¦¼ ìœ í˜•</strong></label>
          <div class="checkbox-row">
            <label><input type="checkbox" id="notifyDesktop"> ë°ìŠ¤í¬í†± ì•Œë¦¼</label>
            <label><input type="checkbox" id="notifySound"> ì‚¬ìš´ë“œ</label>
            <label><input type="checkbox" id="notifyVibrate"> ì§„ë™(ì§€ì› ê¸°ê¸°)</label>
          </div>
        </div>

        <div class="form-row">
          <label for="notifSector"><strong>ì„¹í„° í•„í„°</strong></label>
          <select id="notifSector">
            <option value="all">ì „ì²´ ì„¹í„°</option>
          </select>
          <span class="hint">ì„ íƒí•œ ì„¹í„°ì˜ ë‰´ìŠ¤ë§Œ ì•Œë¦¼ì„ ë°›ìŠµë‹ˆë‹¤.</span>
        </div>

        <div class="form-row">
          <label for="notifTickers"><strong>í‹°ì»¤ í•„í„°</strong></label>
          <input id="notifTickers" type="text" placeholder="ì˜ˆ: NVDA, TSLA (ì‰¼í‘œë¡œ êµ¬ë¶„)">
          <span class="hint">ì…ë ¥ ì‹œ í•´ë‹¹ í‹°ì»¤ë§Œ ì•Œë¦¼. ë¹„ì›Œë‘ë©´ ì „ì²´.</span>
        </div>

        <div class="form-row">
          <label><strong>ê¸°íƒ€</strong></label>
          <label><input type="checkbox" id="notifyOnlyNew" checked> ìƒˆë¡œ ìƒì„±ëœ ë‰´ìŠ¤ë§Œ ì•Œë¦¼</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNotifications()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="saveNotificationPrefs()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì•Œë¦¼ ì‚¬ìš´ë“œ -->
  <audio id="notifSound" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA..." type="audio/mpeg">
  </audio>


  <!-- ì¢…ëª© ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="manageBackdrop" class="modal-backdrop" onclick="backdropClickManage(event)">
    <div class="modal manage-modal" role="dialog" aria-modal="true" aria-labelledby="manageTitle" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 id="manageTitle">ğŸ›  ì¢…ëª© ì¶”ê°€/ì‚­ì œ</h3>
        <button class="btn btn-ghost" onclick="closeManageStocks()" style="font-size: 1em;">ë‹«ê¸°</button>
      </div>
      <div class="modal-body">
        <!-- ì²« ë²ˆì§¸ ì¤„: ì„¹í„° ì„ íƒ, ê²€ìƒ‰, ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê°€ë¡œë¡œ ë°°ì¹˜ -->
        <div style="display: grid; grid-template-columns: 200px 1fr 400px; gap: 16px; align-items: start; margin-bottom: 20px;">
          <div class="form-row" style="margin:0;">
            <label for="manageSector" style="font-size: 1em; font-weight: 600; margin-bottom: 8px;"><strong>ğŸ“‚ ì„¹í„° ì„ íƒ</strong></label>
            <select id="manageSector" onchange="renderManageList()" style="padding: 12px 14px; font-size: 1em; border: 2px solid #dee2e6; border-radius: 10px; width:100%;"></select>
          </div>
          <div class="form-row" style="margin:0;">
            <label style="font-size: 1em; font-weight: 600; margin-bottom: 8px;"><strong>ğŸ” ê²€ìƒ‰</strong></label>
            <input type="text" id="manageSearch" placeholder="í‹°ì»¤, ì„¹í„°ëª…, ì¢…ëª©ëª… ë“±ìœ¼ë¡œ ê²€ìƒ‰..." 
                   style="width:100%; padding:12px 14px; border:2px solid #dee2e6; border-radius:10px; font-size:1em;"
                   oninput="searchStocks()" onkeypress="if(event.key==='Enter') searchStocks()">
          </div>
          <div class="form-row" style="margin:0;">
            <label style="font-size: 1em; font-weight: 600; margin-bottom: 8px;"><strong>ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼</strong></label>
            <div id="manageList" style="display:grid; gap:8px; max-height:400px; overflow-y:auto; border:2px solid #dee2e6; border-radius:10px; padding:12px; background:#fafafa;"></div>
          </div>
        </div>
        
        <!-- ë‘ ë²ˆì§¸ ì¤„: í˜„ì¬ ì„¹í„° ì¢…ëª© (ìŠ¤í¬ë¡¤ ì—†ì´ ìµœëŒ€ 20ê°œ í‘œì‹œ, í•œ ì¤„ì— 5ê°œ) -->
        <div class="form-row">
          <label style="font-size: 1.1em; font-weight: 600; margin-bottom: 8px;"><strong>ğŸ“Š í˜„ì¬ ì„¹í„° ì¢…ëª© (ìµœëŒ€ 20ê°œ)</strong></label>
          <div id="currentStocksList" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; border:2px solid #dee2e6; border-radius:10px; background:#f0f7ff; padding:16px; overflow:visible;"></div>
          <span class="hint" style="font-size: 0.95em; margin-top: 6px;">í˜„ì¬ ì„ íƒëœ ì„¹í„°ì— ë“±ë¡ëœ ì¢…ëª© ëª©ë¡ì…ë‹ˆë‹¤. (ìµœëŒ€ 20ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥)</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeManageStocks()" style="padding: 12px 24px; font-size: 1.05em;">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="saveManagedStocks()" style="padding: 12px 24px; font-size: 1.05em;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    const sectors = [
      { name: "ì¸ê³µì§€ëŠ¥ (AI)", stocks: ["MSFT", "GOOGL", "META", "AMZN", "NVDA", "PLTR", "AI", "SOUN"] },
      { name: "ë°˜ë„ì²´ (Semiconductor)", stocks: ["NVDA", "TSM", "INTC", "AMD", "AVGO", "QCOM", "MU", "AMAT", "ASML", "LRCX"] },
      { name: "ë°”ì´ì˜¤/ì œì•½ (Biotech)", stocks: ["LLY", "NVO", "JNJ", "UNH", "PFE", "MRNA", "REGN", "AMGN"] },
      { name: "ì–‘ìì»´í“¨í„° (Quantum)", stocks: ["IONQ", "QBTS", "RGTI", "QUBT", "ARQQ", "IBM"] },
      { name: "ì›ì „/ìˆ˜ì†Œ/ì—ë„ˆì§€", stocks: ["AMZN", "MSFT", "GOOGL", "CRM", "ORCL", "SNOW", "NOW", "WDAY"] },
      { name: "í¬í† ë¥˜ (Rare Earth)", stocks: ["MP", "UUUU", "LYC", "NEO"] },
      { name: "ë“œë¡ /ë¡œë³´í‹±ìŠ¤", stocks: ["TSLA", "ABB", "ROK", "ISRG", "IRBT", "SYM"] },
      { name: "í•€í…Œí¬/ì½”ì¸", stocks: ["PYPL", "SQ", "V", "MA", "COIN", "HOOD", "SOFI", "AFRM"] },
      { name: "ì „ê¸°ì°¨/ë°°í„°ë¦¬ (EV)", stocks: ["TSLA", "RIVN", "LCID", "NIO", "XPEV", "LI", "F", "GM", "ALB", "LTHM"] },
      { name: "ì‚¬ì´ë²„ë³´ì•ˆ", stocks: ["CRWD", "PANW", "FTNT", "ZS", "S", "OKTA", "CYBR", "NET"] },
      { name: "ë°©ì‚°ìš°ì£¼í•­ê³µ", stocks: ["LMT", "BA", "NOC", "RTX", "GD", "RKLB", "SPCE"] },
      { name: "ë©”íƒ€ë²„ìŠ¤/ê²Œì„", stocks: ["RBLX", "U", "EA", "ATVI", "TTWO", "META", "MSFT"] },
      { name: "í†µì‹ /ì†Œí”„íŠ¸ì›¨ì–´", stocks: ["QCOM", "ERIC", "NOK", "TMUS", "VZ", "T", "CSCO"] },
      { name: "ê¸°íƒ€ ì¢…ëª©", stocks: ["ALB", "LTHM", "SQM", "PLL", "LAC", "QS", "SLDP"] }
    ];

    let currentSector = 'all';
    let currentSearch = '';
    let allStocks = [];
    let notificationPrefs = null;
    let lastNotifiedIds = new Set();
    let lastNews = []; // ì „ì²´ ë‰´ìŠ¤ (í†µê³„ìš©)
    let displayedNews = []; // í˜„ì¬ í‘œì‹œí•  ë‰´ìŠ¤ (í•„í„°ë§ëœ ë‰´ìŠ¤)
    const PAGE_SIZE = 20;
    let currentPage = 1;
    let scrollHandlerAttached = false;
    let scrollContainer = null;
    const CUSTOM_STOCKS_KEY = 'custom_stocks_v1';
    const SECTOR_OVERRIDES_KEY = 'sector_overrides_v1';
    const NEWS_STORAGE_KEY = 'stock_news_v1';
    const NEWS_RETENTION_HOURS = 48; // ë‰´ìŠ¤ ë³´ê´€ ê¸°ê°„ (ì‹œê°„)

    // í•˜ë…¸ì´ ì‹œê°„ ê¸°ì¤€ ì˜¤ëŠ˜ ë‰´ìŠ¤ ë²”ìœ„ ê³„ì‚° (UTC+7, ì „ë‚  ì˜¤ì „ 10ì‹œ ~ ê¸ˆì¼ ì˜¤ì „ 10ì‹œ)
    function getHanoiTodayRange() {
      const now = new Date();
      // í˜„ì¬ UTC ì‹œê°„ì„ í•˜ë…¸ì´ ì‹œê°„(UTC+7)ìœ¼ë¡œ ë³€í™˜
      const utcTime = now.getTime() + (now.getTimezoneOffset() * 60 * 1000);
      const hanoiTime = utcTime + (7 * 60 * 60 * 1000); // UTC+7
      const hanoiDate = new Date(hanoiTime);
      
      // í•˜ë…¸ì´ ì‹œê°„ ê¸°ì¤€ ê¸ˆì¼ ì˜¤ì „ 10ì‹œ ìƒì„±
      const today10AM = new Date(hanoiDate);
      today10AM.setHours(10, 0, 0, 0);
      
      // í•˜ë…¸ì´ ì‹œê°„ ê¸°ì¤€ ì „ë‚  ì˜¤ì „ 10ì‹œ ìƒì„±
      const yesterday10AM = new Date(today10AM);
      yesterday10AM.setDate(yesterday10AM.getDate() - 1);
      
      // UTC timestampë¡œ ë³€í™˜ (createdAtì€ UTC timestamp)
      // í•˜ë…¸ì´ ì‹œê°„ì„ UTCë¡œ ë‹¤ì‹œ ë³€í™˜
      const hanoiOffsetMs = 7 * 60 * 60 * 1000;
      return {
        start: yesterday10AM.getTime() - hanoiOffsetMs,
        end: today10AM.getTime() - hanoiOffsetMs
      };
    }

    function isHanoiTodayNews(item) {
      if (!item.createdAt) return false;
      const range = getHanoiTodayRange();
      return item.createdAt >= range.start && item.createdAt < range.end;
    }

    // ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜ (YYYY/MM/DD/HH:MM)
    function formatDateTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}/${month}/${day}/${hours}:${minutes}`;
    }

    // 48ì‹œê°„ ì´ìƒ ëœ ë‰´ìŠ¤ í•„í„°ë§ (ì‚­ì œ)
    function filterOldNews(newsArray) {
      if (!Array.isArray(newsArray)) return [];
      const now = Date.now();
      const retentionMs = NEWS_RETENTION_HOURS * 60 * 60 * 1000; // 48ì‹œê°„ì„ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜
      return newsArray.filter(item => {
        if (!item.createdAt) return false;
        // 48ì‹œê°„ ì´ë‚´ ë‰´ìŠ¤ë§Œ ìœ ì§€
        return (now - item.createdAt) < retentionMs;
      });
    }

    // localStorageì—ì„œ ë‰´ìŠ¤ ë¡œë“œ
    function loadStoredNews() {
      try {
        const stored = localStorage.getItem(NEWS_STORAGE_KEY);
        if (!stored) return [];
        const news = JSON.parse(stored);
        // 48ì‹œê°„ ì´ìƒ ëœ ë‰´ìŠ¤ ì œê±°
        const filteredNews = filterOldNews(news);
        // í•„í„°ë§ëœ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ì €ì¥ (ì˜¤ë˜ëœ ë‰´ìŠ¤ ì‚­ì œ)
        if (filteredNews.length !== news.length) {
          saveStoredNews(filteredNews);
        }
        return filteredNews;
      } catch (e) {
        console.error('ë‰´ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', e);
        return [];
      }
    }

    // localStorageì— ë‰´ìŠ¤ ì €ì¥
    function saveStoredNews(newsArray) {
      try {
        const filteredNews = filterOldNews(newsArray);
        localStorage.setItem(NEWS_STORAGE_KEY, JSON.stringify(filteredNews));
      } catch (e) {
        console.error('ë‰´ìŠ¤ ì €ì¥ ì‹¤íŒ¨:', e);
      }
    }

    // ëª¨ë“  ì €ì¥ëœ ë‰´ìŠ¤ ì‚­ì œ
    function clearAllNews() {
      try {
        localStorage.removeItem(NEWS_STORAGE_KEY);
        // í™”ë©´ì— í‘œì‹œëœ ë‰´ìŠ¤ë„ ì´ˆê¸°í™”
        const newsGrid = document.getElementById('newsGrid');
        if (newsGrid) {
          newsGrid.innerHTML = `
            <div class="no-news">
              <div class="no-news-icon">ğŸ“°</div>
              <h3>ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
              <p>ìƒˆë¡œìš´ ë‰´ìŠ¤ê°€ ë¡œë“œë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
            </div>
          `;
        }
        // ë‰´ìŠ¤ ë³€ìˆ˜ ì´ˆê¸°í™”
        lastNews = [];
        displayedNews = [];
        currentPage = 1;
        // í†µê³„ ì—…ë°ì´íŠ¸
        document.getElementById('todayNews').textContent = '0';
        // ì„¹í„°ë³„ ë‰´ìŠ¤ ê°œìˆ˜ ì´ˆê¸°í™”
        renderSectorList();
        console.log('ëª¨ë“  ë‰´ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        console.error('ë‰´ìŠ¤ ì‚­ì œ ì‹¤íŒ¨:', e);
      }
    }

    // í…ìŠ¤íŠ¸ë¥¼ í•œêµ­ì–´ë¡œ ë²ˆì—­í•˜ëŠ” í•¨ìˆ˜
    async function translateToKorean(text) {
      if (!text || text.trim().length === 0) return text;
      
      // í‹°ì»¤ íŒ¨í„´ ë³´ì¡´ (ëŒ€ë¬¸ì 2-5ì)
      // ì•Œë ¤ì§„ ì¼ë°˜ ë‹¨ì–´ ì œì™¸ (THE, AND, ARE, FOR, YOU, WAS, HIS, HER, ITS, OUR ë“±)
      const commonWords = new Set(['THE', 'AND', 'ARE', 'FOR', 'YOU', 'WAS', 'HIS', 'HER', 'ITS', 'OUR', 'ALL', 'CAN', 'HAS', 'HAD', 'NOT', 'BUT', 'USE', 'SAY', 'MAY', 'WAY', 'NEW', 'NOW', 'OLD', 'DAY', 'GET', 'MAY', 'SEE', 'MAN', 'TWO', 'OUT', 'HOW', 'WHO', 'OIL', 'ITS', 'WAY', 'USE', 'HER', 'SHE', 'HIM', 'HIS', 'OUR', 'OUT', 'DAY', 'GET', 'NEW', 'NOW', 'OLD', 'TWO', 'SEE', 'MAN']);
      const tickerPattern = /\b[A-Z]{2,5}\b/g;
      const tickerMap = new Map();
      
      // í‹°ì»¤ ì°¾ê¸° ë° ì„ì‹œ í”Œë ˆì´ìŠ¤í™€ë”ë¡œ êµì²´
      let textWithPlaceholders = text;
      let tickerIndex = 0;
      
      // ëª¨ë“  ì•Œë ¤ì§„ í‹°ì»¤ ìˆ˜ì§‘ (ëª¨ë“  ì„¹í„°ì—ì„œ)
      const allKnownTickers = new Set();
      sectors.forEach(sector => {
        sector.stocks.forEach(ticker => {
          allKnownTickers.add(ticker.toUpperCase());
        });
      });
      
      textWithPlaceholders = text.replace(tickerPattern, (match, offset) => {
        const upperMatch = match.toUpperCase();
        // ì•Œë ¤ì§„ í‹°ì»¤ì´ê±°ë‚˜ ì¼ë°˜ ë‹¨ì–´ê°€ ì•„ë‹Œ ê²½ìš° ë³´ì¡´
        if (allKnownTickers.has(upperMatch) || (!commonWords.has(upperMatch) && match.length >= 2 && match.length <= 5 && /^[A-Z]+$/.test(match))) {
          const placeholder = `__TICKER_${tickerIndex}__`;
          tickerMap.set(placeholder, match);
          tickerIndex++;
          return placeholder;
        }
        return match;
      });
      
      // í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê¸¸ë©´ ì˜ë¼ì„œ ë²ˆì—­ (ë²ˆì—­ API ì œí•œ ê³ ë ¤)
      const maxLength = 500;
      const isLong = textWithPlaceholders.length > maxLength;
      const textToTranslate = isLong ? textWithPlaceholders.substring(0, maxLength) : textWithPlaceholders;
      
      try {
        // í‹°ì»¤ë§Œ ìˆëŠ” í…ìŠ¤íŠ¸ëŠ” ë²ˆì—­í•˜ì§€ ì•ŠìŒ
        if (text.trim().match(/^\b[A-Z]{1,5}\b$/)) {
          return text;
        }
        
        // ì´ë¯¸ í•œêµ­ì–´ì¸ì§€ í™•ì¸ (í•œê¸€ ìœ ë‹ˆì½”ë“œ ë²”ìœ„) - ë” ì—„ê²©í•œ ì²´í¬
        const koreanRegex = /[ã„±-ã…|ã…-ã…£|ê°€-í£]/;
        const koreanChars = (text.match(/[ã„±-ã…|ã…-ã…£|ê°€-í£]/g) || []);
        const koreanRatio = koreanChars.length / (text.length || 1);
        // í•œêµ­ì–´ ë¹„ìœ¨ì´ 50% ì´ìƒì´ë©´ ì´ë¯¸ í•œêµ­ì–´ë¡œ ê°„ì£¼ (ë” ì—„ê²©í•œ ê¸°ì¤€)
        // ë‹¨, í…ìŠ¤íŠ¸ê°€ ë§¤ìš° ì§§ê³ (10ì ë¯¸ë§Œ) ì˜ì–´ê°€ ëŒ€ë¶€ë¶„ì¸ ê²½ìš°ëŠ” ë²ˆì—­ ì‹œë„
        if (koreanRatio > 0.5 && text.length >= 10) {
          return text; // ì´ë¯¸ í•œêµ­ì–´ë©´ ë²ˆì—­í•˜ì§€ ì•ŠìŒ
        }
        
        // ì˜ì–´ ì•ŒíŒŒë²³ ë¹„ìœ¨ í™•ì¸ (ëŒ€ë¶€ë¶„ ì˜ì–´ì¸ ê²½ìš° ê°•ì œ ë²ˆì—­)
        const englishChars = (text.match(/[a-zA-Z]/g) || []);
        const englishRatio = englishChars.length / (text.length || 1);
        // ì˜ì–´ ë¹„ìœ¨ì´ 70% ì´ìƒì´ê³  í•œêµ­ì–´ ë¹„ìœ¨ì´ 10% ë¯¸ë§Œì´ë©´ ë²ˆì—­ í•„ìš”
        if (englishRatio > 0.7 && koreanRatio < 0.1) {
          // ê°•ì œ ë²ˆì—­ ì§„í–‰
        }
        
        // ìˆ«ìë§Œ ìˆëŠ” í…ìŠ¤íŠ¸ëŠ” ë²ˆì—­í•˜ì§€ ì•ŠìŒ
        if (/^\d+[\s\.,\-]*$/.test(text.trim())) {
          return text;
        }
        
        // MyMemory Translation API ì‚¬ìš© (ë¬´ë£Œ, API í‚¤ ë¶ˆí•„ìš”)
        const apiUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=en|ko`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          console.warn('ë²ˆì—­ API í˜¸ì¶œ ì‹¤íŒ¨:', response.status);
          return text; // ë²ˆì—­ ì‹¤íŒ¨ ì‹œ ì›ë¬¸ ë°˜í™˜
        }
        
        const data = await response.json();
        if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
          let translated = data.responseData.translatedText;
          // ë²ˆì—­ ê²°ê³¼ ì •ë¦¬
          translated = translated.replace(/\s+/g, ' ').trim();
          
          // ë²ˆì—­ ê²°ê³¼ê°€ ì›ë¬¸ê³¼ ë™ì¼í•˜ê±°ë‚˜ ë„ˆë¬´ ë¹„ìŠ·í•˜ë©´ ë‹¤ë¥¸ ë²ˆì—­ API ì‹œë„
          if (translated.toLowerCase() === textToTranslate.toLowerCase() || 
              (translated.length === textToTranslate.length && translated.toLowerCase().substring(0, 10) === textToTranslate.toLowerCase().substring(0, 10))) {
            // ë‹¤ë¥¸ ë²ˆì—­ API ì‹œë„ (LibreTranslate ë˜ëŠ” ì§ì ‘ ì¬ì‹œë„)
            console.log('ë²ˆì—­ ê²°ê³¼ê°€ ì›ë¬¸ê³¼ ë™ì¼, ì¬ë²ˆì—­ ì‹œë„:', textToTranslate.substring(0, 50));
            // ì¬ì‹œë„ëŠ” í•˜ì§€ ì•Šê³  ì›ë¬¸ ë°˜í™˜í•˜ë˜, ê°•ì œ ë²ˆì—­ í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ ê³„ì† ì‹œë„
          }
          
          // í•œêµ­ì–´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          const koreanRegex = /[ã„±-ã…|ã…-ã…£|ê°€-í£]/;
          const hasKorean = koreanRegex.test(translated);
          
          // ë²ˆì—­ ê²°ê³¼ì— í•œêµ­ì–´ê°€ ì—†ìœ¼ë©´ ì›ë¬¸ ë°˜í™˜ (ë²ˆì—­ ì‹¤íŒ¨ë¡œ ê°„ì£¼)
          if (!hasKorean && textToTranslate.length > 5) {
            // ì§§ì€ í…ìŠ¤íŠ¸ê°€ ì•„ë‹ˆë©´ ë²ˆì—­ ì‹¤íŒ¨ë¡œ ê°„ì£¼
            console.warn('ë²ˆì—­ ê²°ê³¼ì— í•œêµ­ì–´ê°€ ì—†ìŒ:', translated);
            // ì›ë¬¸ ë°˜í™˜
            return text;
          }
          
          // í‹°ì»¤ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì›ë˜ í‹°ì»¤ë¡œ ë³µì›
          tickerMap.forEach((ticker, placeholder) => {
            translated = translated.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), ticker);
          });
          
          // ì›ë¬¸ì´ ê¸¸ì—ˆìœ¼ë©´ ìƒëµ í‘œì‹œ ì¶”ê°€
          if (isLong && translated.length < text.length) {
            translated += '...';
          }
          return translated;
        }
        
        // ë²ˆì—­ ì‹¤íŒ¨ ì‹œ í‹°ì»¤ ë³µì› í›„ ì›ë¬¸ ë°˜í™˜
        if (tickerMap.size > 0) {
          let restoredText = text;
          tickerMap.forEach((ticker, placeholder) => {
            restoredText = restoredText.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), ticker);
          });
          return restoredText;
        }
        return text; // ë²ˆì—­ ì‹¤íŒ¨ ì‹œ ì›ë¬¸ ë°˜í™˜
      } catch (error) {
        console.error('ë²ˆì—­ ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í‹°ì»¤ ë³µì›
        if (tickerMap.size > 0) {
          let restoredText = text;
          tickerMap.forEach((ticker, placeholder) => {
            restoredText = restoredText.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), ticker);
          });
          return restoredText;
        }
        return text; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì›ë¬¸ ë°˜í™˜
      }
    }

    // ë‰´ìŠ¤ ë°°ì—´ì˜ ì œëª©ë§Œ í•œêµ­ì–´ë¡œ ë²ˆì—­
    async function translateNews(newsArray) {
      if (!Array.isArray(newsArray) || newsArray.length === 0) {
        return newsArray;
      }
      
      // ìˆœì°¨ì ìœ¼ë¡œ ë²ˆì—­ (ë„ˆë¬´ ë§ì€ ë™ì‹œ ìš”ì²­ ë°©ì§€, API ì œí•œ ê³ ë ¤)
      const translatedNews = [];
      for (let i = 0; i < newsArray.length; i++) {
        const item = newsArray[i];
        try {
          // ì›ë¬¸ì´ ìˆìœ¼ë©´ ì›ë¬¸ì„, ì—†ìœ¼ë©´ í˜„ì¬ í…ìŠ¤íŠ¸ë¥¼ ë²ˆì—­ ëŒ€ìƒìœ¼ë¡œ ì‚¬ìš©
          const koreanRegex = /[ã„±-ã…|ã…-ã…£|ê°€-í£]/;
          const titleKoreanRatio = ((item.title || '').match(/[ã„±-ã…|ã…-ã…£|ê°€-í£]/g) || []).length / ((item.title || '').length || 1);
          
          // ë²ˆì—­í•  ì›ë¬¸ í…ìŠ¤íŠ¸ ê²°ì • (ì˜ì–´ê°€ ë§ì´ í¬í•¨ëœ í…ìŠ¤íŠ¸ ì‚¬ìš©)
          const textToTranslateTitle = item.originalTitle || (titleKoreanRatio < 0.3 ? item.title : item.originalTitle || item.title);
          
          // ì œëª©ë§Œ ë²ˆì—­ (ìš”ì•½ê³¼ ë‚´ìš©ì€ ì›ë¬¸ ìœ ì§€)
          const translatedTitle = await translateToKorean(textToTranslateTitle);
          
          // ì›ë¬¸ ë³´ì¡´
          const useOriginalTitle = item.originalTitle || textToTranslateTitle;
          const useOriginalSummary = item.originalSummary || item.summary;
          const useOriginalContent = item.originalContent || item.content || item.summary;
          
          translatedNews.push({
            ...item,
            originalTitle: useOriginalTitle, // ì›ë¬¸ ë³´ì¡´ (í•„ìš”ì‹œ ì‚¬ìš©)
            originalSummary: useOriginalSummary, // ì›ë¬¸ ë³´ì¡´
            originalContent: useOriginalContent, // ì›ë¬¸ ë‚´ìš© ë³´ì¡´
            title: translatedTitle,
            summary: item.summary || useOriginalSummary, // ì›ë¬¸ ìš”ì•½ ìœ ì§€
            content: item.content || useOriginalContent, // ì›ë¬¸ ë‚´ìš© ìœ ì§€
            titleTranslated: true // ë²ˆì—­ ì™„ë£Œ í‘œì‹œ
          });
          
          // API í˜¸ì¶œ ì œí•œì„ ê³ ë ¤í•œ ë”œë ˆì´
          await new Promise(resolve => setTimeout(resolve, 200));
          
          // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ (ì„ íƒì )
          if ((i + 1) % 5 === 0 && document.getElementById('newsGrid')) {
            document.getElementById('newsGrid').innerHTML = 
              '<div class="loading"><div class="spinner"></div><p>ì œëª©ì„ ë²ˆì—­í•˜ëŠ” ì¤‘... (' + (i + 1) + '/' + newsArray.length + ')</p></div>';
          }
        } catch (error) {
          console.error('ë‰´ìŠ¤ ë²ˆì—­ ì˜¤ë¥˜:', error, item);
          // ë²ˆì—­ ì‹¤íŒ¨ ì‹œ ì›ë¬¸ ì‚¬ìš©
          translatedNews.push(item);
        }
      }
      
      return translatedNews;
    }

    // ìƒˆ ë‰´ìŠ¤ë¥¼ ê¸°ì¡´ ë‰´ìŠ¤ì™€ ë³‘í•© (ì¤‘ë³µ ì œê±°)
    function mergeNews(existingNews, newNews) {
      if (!Array.isArray(existingNews)) existingNews = [];
      if (!Array.isArray(newNews)) newNews = [];
      
      // ê¸°ì¡´ ë‰´ìŠ¤ì™€ ìƒˆ ë‰´ìŠ¤ë¥¼ í•©ì¹˜ê³  ì¤‘ë³µ ì œê±°
      // ì¤‘ë³µ ê¸°ì¤€: ticker + title + createdAt (1ë¶„ ì´ë‚´)
      const allNews = [...existingNews];
      const existingIds = new Set(
        existingNews.map(n => `${n.ticker}|${n.title}|${Math.floor((n.createdAt || 0) / 60000)}`)
      );

      newNews.forEach(newItem => {
        const id = `${newItem.ticker}|${newItem.title}|${Math.floor((newItem.createdAt || 0) / 60000)}`;
        if (!existingIds.has(id)) {
          allNews.push(newItem);
          existingIds.add(id);
        }
      });

      // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
      return allNews.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    }

    // ëª¨ë“  ì¢…ëª© í‹°ì»¤ ìˆ˜ì§‘
    sectors.forEach(sector => {
      allStocks.push(...sector.stocks);
    });

    function rebuildAllStocks() {
      allStocks = [];
      sectors.forEach(sector => {
        sector.stocks = Array.from(new Set(sector.stocks));
        allStocks.push(...sector.stocks);
      });
      // ì´ ì¶”ì  ì¢…ëª© ìˆ˜ ì—…ë°ì´íŠ¸ (ì¤‘ë³µ ì œê±°ëœ ìµœì¢… ê°œìˆ˜)
      allStocks = Array.from(new Set(allStocks));
      const totalEl = document.getElementById('totalStocks');
      if (totalEl) totalEl.textContent = allStocks.length;
    }

    // ì„œë²„ì—ì„œ ì¢…ëª© ë°ì´í„° ë¡œë“œ
    async function loadStocksFromServer() {
      try {
        const response = await fetch('/api/stocks');
        if (!response.ok) {
          console.warn('ì„œë²„ì—ì„œ ì¢…ëª© ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. localStorageë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
          return null;
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.warn('ì„œë²„ ì—°ê²° ì‹¤íŒ¨, localStorageë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:', error);
        return null;
      }
    }

    // ì„œë²„ì— ì¢…ëª© ë°ì´í„° ì €ì¥
    async function saveStocksToServer(data) {
      try {
        const response = await fetch('/api/stocks', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        if (!response.ok) {
          console.warn('ì„œë²„ì— ì¢…ëª© ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return false;
        }
        const result = await response.json();
        return result.success === true;
      } catch (error) {
        console.warn('ì„œë²„ ì €ì¥ ì‹¤íŒ¨:', error);
        return false;
      }
    }

    // ì„œë²„ì™€ localStorage ë°ì´í„° ë³‘í•©
    function mergeStocksData(serverData, localData) {
      const merged = {
        sectorOverrides: {},
        customStocks: {}
      };

      // ì„œë²„ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      if (serverData && serverData.sectorOverrides) {
        Object.assign(merged.sectorOverrides, serverData.sectorOverrides);
      }
      if (serverData && serverData.customStocks) {
        Object.assign(merged.customStocks, serverData.customStocks);
      }

      // localStorage ë°ì´í„° ë³‘í•© (ì„œë²„ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë” ìµœì‹ ì¸ ê²½ìš°)
      if (localData) {
        if (localData.sectorOverrides) {
          Object.keys(localData.sectorOverrides).forEach(key => {
            if (!merged.sectorOverrides[key] || 
                JSON.stringify(merged.sectorOverrides[key]) !== JSON.stringify(localData.sectorOverrides[key])) {
              merged.sectorOverrides[key] = localData.sectorOverrides[key];
            }
          });
        }
        if (localData.customStocks) {
          Object.keys(localData.customStocks).forEach(key => {
            if (!merged.customStocks[key]) {
              merged.customStocks[key] = localData.customStocks[key];
            }
          });
        }
      }

      return merged;
    }

    async function applyCustomStocksFromStorage() {
      try {
        // ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„
        const serverData = await loadStocksFromServer();
        
        // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ
        const localSectorOverrides = localStorage.getItem(SECTOR_OVERRIDES_KEY);
        const localCustomStocks = localStorage.getItem(CUSTOM_STOCKS_KEY);
        
        const localData = {
          sectorOverrides: localSectorOverrides ? JSON.parse(localSectorOverrides) : {},
          customStocks: localCustomStocks ? JSON.parse(localCustomStocks) : {}
        };

        // ì„œë²„ì™€ localStorage ë°ì´í„° ë³‘í•©
        const mergedData = mergeStocksData(serverData, localData);

        // ë³‘í•©ëœ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥ (ë™ê¸°í™”)
        if (Object.keys(mergedData.sectorOverrides).length > 0) {
          localStorage.setItem(SECTOR_OVERRIDES_KEY, JSON.stringify(mergedData.sectorOverrides));
        }
        if (Object.keys(mergedData.customStocks).length > 0) {
          localStorage.setItem(CUSTOM_STOCKS_KEY, JSON.stringify(mergedData.customStocks));
        }

        // ì„œë²„ ë°ì´í„°ê°€ ìˆê³  localStorageì™€ ë‹¤ë¥´ë©´ ì„œë²„ì— ì €ì¥ (ë™ê¸°í™”)
        if (serverData && (
          JSON.stringify(mergedData.sectorOverrides) !== JSON.stringify(serverData.sectorOverrides || {}) ||
          JSON.stringify(mergedData.customStocks) !== JSON.stringify(serverData.customStocks || {})
        )) {
          await saveStocksToServer(mergedData);
        }

        // ì„¹í„°ë³„ ì „ì²´ ì˜¤ë²„ë¼ì´ë“œ ì ìš© (ìˆìœ¼ë©´ ìš°ì„ )
        if (mergedData.sectorOverrides) {
          Object.keys(mergedData.sectorOverrides).forEach(key => {
            const idx = parseInt(key);
            if (Number.isInteger(idx) && sectors[idx]) {
              const arr = (mergedData.sectorOverrides[key] || []).map(s => String(s).toUpperCase()).filter(Boolean);
              sectors[idx].stocks = Array.from(new Set(arr));
            }
          });
        }

        // ì»¤ìŠ¤í…€ ì¢…ëª© ì¶”ê°€
        if (mergedData.customStocks) {
          Object.keys(mergedData.customStocks).forEach(key => {
            const idx = parseInt(key);
            if (Number.isInteger(idx) && sectors[idx]) {
              const addList = (mergedData.customStocks[key] || []).map(s => String(s).toUpperCase());
              addList.forEach(t => {
                if (!sectors[idx].stocks.includes(t)) {
                  sectors[idx].stocks.push(t);
                }
              });
            }
          });
        }
        
        rebuildAllStocks();
      } catch (error) {
        console.error('ì¢…ëª© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ===== ì¢…ëª© ê´€ë¦¬ (ì‚­ì œ/í¸ì§‘) =====
    function openManageStocks() {
      // ì„¹í„° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
      const sel = document.getElementById('manageSector');
      sel.innerHTML = sectors.map((s, i) => `<option value="${i}">${s.name}</option>`).join('');
      sel.value = currentSector === 'all' ? '0' : String(currentSector);
      renderManageList();
      document.getElementById('manageBackdrop').style.display = 'flex';
    }

    function closeManageStocks() {
      document.getElementById('manageBackdrop').style.display = 'none';
    }

    function backdropClickManage(e) {
      if (e.target.id === 'manageBackdrop') closeManageStocks();
    }

    // ì£¼ì‹ ê²€ìƒ‰ í•¨ìˆ˜ - í‹°ì»¤, ì„¹í„°ëª…, ì¢…ëª©ëª… ë“±ìœ¼ë¡œ ê²€ìƒ‰
    function searchStocks() {
      const searchTerm = (document.getElementById('manageSearch')?.value || '').trim().toLowerCase();
      const resultsDiv = document.getElementById('manageList');
      const idx = parseInt(document.getElementById('manageSector')?.value || '0');
      const currentStocks = new Set(sectors[idx]?.stocks || []);
      
      if (!searchTerm) {
        resultsDiv.innerHTML = '<div class="hint">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
        return;
      }
      
      const results = [];
      
      // 1. í‹°ì»¤ë¡œ ê²€ìƒ‰ (ëª¨ë“  ì„¹í„°ì—ì„œ)
      sectors.forEach((sector, sectorIdx) => {
        sector.stocks.forEach(ticker => {
          if (ticker.toLowerCase().includes(searchTerm)) {
            results.push({
              ticker: ticker,
              sectorName: sector.name,
              sectorIdx: sectorIdx,
              type: 'ticker'
            });
          }
        });
      });
      
      // 2. ì„¹í„°ëª…ìœ¼ë¡œ ê²€ìƒ‰ (í•œê¸€, ì˜ë¬¸ ëª¨ë‘ ì§€ì›)
      const sectorKeywords = {
        'ë°˜ë„ì²´': ['ë°˜ë„ì²´', 'semiconductor', 'chip', 'ì¹©'],
        'ai': ['ai', 'ì¸ê³µì§€ëŠ¥', 'artificial intelligence', 'ë¨¸ì‹ ëŸ¬ë‹', 'machine learning'],
        'ë°”ì´ì˜¤': ['ë°”ì´ì˜¤', 'ì œì•½', 'biotech', 'pharma', 'pharmaceutical', 'í—¬ìŠ¤ì¼€ì–´', 'healthcare'],
        'ì „ê¸°ì°¨': ['ì „ê¸°ì°¨', 'ev', 'electric vehicle', 'ë°°í„°ë¦¬', 'battery'],
        'ì›ì „': ['ì›ì „', 'ìˆ˜ì†Œ', 'ì—ë„ˆì§€', 'nuclear', 'hydrogen', 'energy', 'power'],
        'ë°©ì‚°': ['ë°©ì‚°', 'ìš°ì£¼', 'í•­ê³µ', 'defense', 'aerospace', 'space'],
        'ë³´ì•ˆ': ['ë³´ì•ˆ', 'ì‚¬ì´ë²„', 'cybersecurity', 'security', 'cyber'],
        'ê¸ˆìœµ': ['ê¸ˆìœµ', 'í•€í…Œí¬', 'ì½”ì¸', 'fintech', 'finance', 'coin', 'crypto'],
        'ê²Œì„': ['ê²Œì„', 'game', 'ë©”íƒ€ë²„ìŠ¤', 'metaverse'],
        'ë¡œë´‡': ['ë¡œë´‡', 'ë“œë¡ ', 'robotics', 'robot', 'drone'],
        'í†µì‹ ': ['í†µì‹ ', 'ì†Œí”„íŠ¸ì›¨ì–´', 'telecom', 'communication', 'software'],
        'í¬í† ë¥˜': ['í¬í† ë¥˜', 'rare earth', 'rare'],
        'ì–‘ì': ['ì–‘ì', 'quantum', 'quantum computing']
      };
      
      sectors.forEach((sector, sectorIdx) => {
        const sectorNameLower = sector.name.toLowerCase();
        let isMatch = false;
        
        // ì§ì ‘ ì„¹í„°ëª… ë§¤ì¹­
        if (sectorNameLower.includes(searchTerm) || 
            searchTerm.includes(sectorNameLower.split('(')[0].trim().toLowerCase())) {
          isMatch = true;
        }
        
        // í‚¤ì›Œë“œ ë§¤ì¹­
        Object.keys(sectorKeywords).forEach(key => {
          if (sectorNameLower.includes(key.toLowerCase())) {
            sectorKeywords[key].forEach(keyword => {
              if (searchTerm.includes(keyword.toLowerCase()) || keyword.toLowerCase().includes(searchTerm)) {
                isMatch = true;
              }
            });
          }
        });
        
        if (isMatch) {
          sector.stocks.forEach(ticker => {
            results.push({
              ticker: ticker,
              sectorName: sector.name,
              sectorIdx: sectorIdx,
              type: 'sector'
            });
          });
        }
      });
      
      // 3. ì•Œë ¤ì§„ ì£¼ì‹ í‹°ì»¤ ëª©ë¡ìœ¼ë¡œ ê²€ìƒ‰ (ëŒ€í˜•ì£¼, ì¸ê¸° ì£¼ì‹ ë“±)
      const knownStocks = {
        // ê¸°ìˆ ì£¼
        'aapl': 'AAPL', 'apple': 'AAPL', 'ì• í”Œ': 'AAPL',
        'microsoft': 'MSFT', 'msft': 'MSFT', 'ë§ˆì´í¬ë¡œì†Œí”„íŠ¸': 'MSFT',
        'google': 'GOOGL', 'googl': 'GOOGL', 'alphabet': 'GOOGL', 'êµ¬ê¸€': 'GOOGL',
        'amazon': 'AMZN', 'amzn': 'AMZN', 'ì•„ë§ˆì¡´': 'AMZN',
        'meta': 'META', 'facebook': 'META', 'í˜ì´ìŠ¤ë¶': 'META',
        'tesla': 'TSLA', 'tsla': 'TSLA', 'í…ŒìŠ¬ë¼': 'TSLA',
        'nvidia': 'NVDA', 'nvda': 'NVDA', 'ì—”ë¹„ë””ì•„': 'NVDA',
        'netflix': 'NFLX', 'nflx': 'NFLX', 'ë„·í”Œë¦­ìŠ¤': 'NFLX',
        'intel': 'INTC', 'intc': 'INTC', 'ì¸í…”': 'INTC',
        'amd': 'AMD',
        'oracle': 'ORCL', 'orcl': 'ORCL', 'ì˜¤ë¼í´': 'ORCL',
        'salesforce': 'CRM', 'crm': 'CRM',
        'adobe': 'ADBE', 'adbe': 'ADBE',
        'cisco': 'CSCO', 'csco': 'CSCO',
        'ibm': 'IBM',
        'paypal': 'PYPL', 'pypl': 'PYPL', 'í˜ì´íŒ”': 'PYPL',
        // ê¸ˆìœµì£¼
        'jpmorgan': 'JPM', 'jpm': 'JPM', 'ì œì´í”¼ëª¨ê±´': 'JPM',
        'bank of america': 'BAC', 'bac': 'BAC', 'ë±…í¬ì˜¤ë¸Œì•„ë©”ë¦¬ì¹´': 'BAC',
        'visa': 'V', 'ë¹„ì': 'V',
        'mastercard': 'MA', 'ma': 'MA', 'ë§ˆìŠ¤í„°ì¹´ë“œ': 'MA',
        'goldman sachs': 'GS', 'gs': 'GS',
        'morgan stanley': 'MS', 'ms': 'MS',
        'wells fargo': 'WFC', 'wfc': 'WFC',
        // ì†Œë¹„ì¬
        'walmart': 'WMT', 'wmt': 'WMT', 'ì›”ë§ˆíŠ¸': 'WMT',
        'disney': 'DIS', 'dis': 'DIS', 'ì›”íŠ¸ë””ì¦ˆë‹ˆ': 'DIS', 'ë””ì¦ˆë‹ˆ': 'DIS',
        'coca cola': 'KO', 'ko': 'KO', 'ì½”ì¹´ì½œë¼': 'KO',
        'pepsico': 'PEP', 'pep': 'PEP', 'í©ì‹œì½”': 'PEP',
        'nike': 'NKE', 'nke': 'NKE', 'ë‚˜ì´í‚¤': 'NKE',
        'starbucks': 'SBUX', 'sbux': 'SBUX', 'ìŠ¤íƒ€ë²…ìŠ¤': 'SBUX',
        'mcdonald': 'MCD', 'mcd': 'MCD', 'ë§¥ë„ë‚ ë“œ': 'MCD',
        // í—¬ìŠ¤ì¼€ì–´
        'johnson': 'JNJ', 'jnj': 'JNJ', 'ì¡´ìŠ¨ì•¤ì¡´ìŠ¨': 'JNJ',
        'pfizer': 'PFE', 'pfe': 'PFE', 'í™”ì´ì': 'PFE',
        'unitedhealth': 'UNH', 'unh': 'UNH',
        'abbvie': 'ABBV', 'abbv': 'ABBV',
        'merck': 'MRK', 'mrk': 'MRK',
        // ì‚°ì—…
        'boeing': 'BA', 'ba': 'BA', 'ë³´ì‰': 'BA',
        'caterpillar': 'CAT', 'cat': 'CAT',
        'general electric': 'GE', 'ge': 'GE',
        '3m': 'MMM', 'mmm': 'MMM',
        // ì—ë„ˆì§€
        'exxon': 'XOM', 'xom': 'XOM',
        'chevron': 'CVX', 'cvx': 'CVX',
        // í†µì‹ 
        'verizon': 'VZ', 'vz': 'VZ', 'ë²„ë¼ì´ì¦Œ': 'VZ',
        'at&t': 'T', 'att': 'T',
        // ìœ í‹¸ë¦¬í‹°
        'next era': 'NEE', 'nee': 'NEE',
        // ë¦¬ì–¼ì—ìŠ¤í…Œì´íŠ¸
        'american tower': 'AMT', 'amt': 'AMT'
      };
      
      Object.keys(knownStocks).forEach(key => {
        if (key.includes(searchTerm) || searchTerm.includes(key)) {
          const ticker = knownStocks[key];
          // ì´ë¯¸ ê²°ê³¼ì— ì—†ëŠ” ê²½ìš°ë§Œ ì¶”ê°€
          if (!results.find(r => r.ticker === ticker)) {
            const foundSector = sectors.find(s => s.stocks.includes(ticker));
            results.push({
              ticker: ticker,
              sectorName: foundSector ? foundSector.name : 'ê¸°íƒ€',
              sectorIdx: foundSector ? sectors.indexOf(foundSector) : -1,
              type: 'known'
            });
          }
        }
      });
      
      // 4. ì§ì ‘ í‹°ì»¤ í˜•ì‹ ì…ë ¥ (ëŒ€ë¬¸ì 2-5ì)
      if (/^[A-Z]{2,5}$/i.test(searchTerm)) {
        const ticker = searchTerm.toUpperCase();
        if (!results.find(r => r.ticker === ticker)) {
          results.push({
            ticker: ticker,
            sectorName: 'ì‹ ê·œ',
            sectorIdx: -1,
            type: 'direct'
          });
        }
      }
      
      // ì¤‘ë³µ ì œê±°
      const uniqueResults = [];
      const seen = new Set();
      results.forEach(r => {
        const key = r.ticker;
        if (!seen.has(key)) {
          seen.add(key);
          uniqueResults.push(r);
        }
      });
      
      // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
      if (uniqueResults.length === 0) {
        resultsDiv.innerHTML = '<div class="hint" style="text-align:center; padding:40px; color:#6c757d; font-size:1.05em;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</div>';
      } else {
        let html = '';
        const MAX_STOCKS = 20;
        const currentCount = currentStocks.size;
        const canAddMore = currentCount < MAX_STOCKS;
        
        uniqueResults.slice(0, 50).forEach(result => { // ìµœëŒ€ 50ê°œê¹Œì§€ë§Œ í‘œì‹œ
          const isInCurrentSector = currentStocks.has(result.ticker);
          let actionText = isInCurrentSector ? 'ì œê±°' : 'ì¶”ê°€';
          let actionClass = isInCurrentSector ? 'btn-secondary' : 'btn-primary';
          let disabled = false;
          
          // ì¶”ê°€ ë²„íŠ¼ì´ê³  ì´ë¯¸ 20ê°œê°€ ë„˜ìœ¼ë©´ ë¹„í™œì„±í™”
          if (!isInCurrentSector && !canAddMore) {
            actionClass = 'btn-secondary';
            disabled = true;
            actionText = 'ì¶”ê°€ ë¶ˆê°€ (20ê°œ ì´ˆê³¼)';
          }
          
          html += `
            <div style="display:flex; gap:12px; align-items:center; padding:14px 16px; background:white; border:2px solid #dee2e6; border-radius:10px; transition:all 0.2s; cursor:pointer;" 
                 onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 2px 8px rgba(102,126,234,0.2)'" 
                 onmouseout="this.style.borderColor='#dee2e6'; this.style.boxShadow='none'">
              <span style="font-weight:bold; font-size:1.1em; min-width:80px; color:#333;">${result.ticker}</span>
              <span style="flex:1; color:#6c757d; font-size:1em;">${result.sectorName}</span>
              <button class="btn ${actionClass}" onclick="event.stopPropagation(); toggleStock('${result.ticker}', ${isInCurrentSector})" 
                      style="padding:10px 20px; font-size:0.95em; white-space:nowrap; ${disabled ? 'opacity:0.6; cursor:not-allowed;' : ''}" 
                      ${disabled ? 'disabled' : ''}>
                ${actionText}
              </button>
            </div>
          `;
        });
        
        // í˜„ì¬ ì¢…ëª© ìˆ˜ í‘œì‹œ ì¶”ê°€
        if (uniqueResults.length > 0) {
          const countInfo = `<div style="padding:8px 12px; background:#e9ecef; border-radius:6px; margin-bottom:10px; font-size:0.95em; color:#495057; text-align:center; font-weight:600;">í˜„ì¬ ë“±ë¡ëœ ì¢…ëª©: ${currentCount}ê°œ / ìµœëŒ€ ${MAX_STOCKS}ê°œ${!canAddMore ? ' (ìµœëŒ€ì¹˜ ë„ë‹¬)' : ''}</div>`;
          html = countInfo + html;
        }
        resultsDiv.innerHTML = html;
      }
      
      // í˜„ì¬ ì„¹í„° ì¢…ëª© ëª©ë¡ ì—…ë°ì´íŠ¸
      renderCurrentStocksList();
    }
    
    // ì¢…ëª© ì¶”ê°€/ì œê±° í† ê¸€ (ìµœëŒ€ 20ê°œ ì œí•œ)
    function toggleStock(ticker, isRemoving) {
      const idx = parseInt(document.getElementById('manageSector')?.value || '0');
      if (!Number.isInteger(idx) || !sectors[idx]) return;
      
      const MAX_STOCKS = 20; // ìµœëŒ€ ì¢…ëª© ìˆ˜
      
      if (isRemoving) {
        // ì œê±°
        const stockIdx = sectors[idx].stocks.indexOf(ticker);
        if (stockIdx > -1) {
          sectors[idx].stocks.splice(stockIdx, 1);
        }
      } else {
        // ì¶”ê°€ (20ê°œ ì œí•œ ì²´í¬)
        if (sectors[idx].stocks.length >= MAX_STOCKS) {
          alert(`âš ï¸ ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ìµœëŒ€ ${MAX_STOCKS}ê°œê¹Œì§€ë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ë“±ë¡ëœ ì¢…ëª©: ${sectors[idx].stocks.length}ê°œ\nì¢…ëª©ì„ ì œê±°í•œ í›„ ë‹¤ì‹œ ì¶”ê°€í•´ì£¼ì„¸ìš”.`);
          return;
        }
        if (!sectors[idx].stocks.includes(ticker)) {
          sectors[idx].stocks.push(ticker);
        }
      }
      
      // ê²€ìƒ‰ ê²°ê³¼ ë° í˜„ì¬ ì¢…ëª© ëª©ë¡ ì—…ë°ì´íŠ¸
      searchStocks();
      renderCurrentStocksList();
    }
    
    // í˜„ì¬ ì„¹í„° ì¢…ëª© ëª©ë¡ ë Œë”ë§ (ìµœëŒ€ 20ê°œ í‘œì‹œ)
    function renderCurrentStocksList() {
      const idx = parseInt(document.getElementById('manageSector')?.value || '0');
      const currentDiv = document.getElementById('currentStocksList');
      const list = (sectors[idx]?.stocks || []).sort();
      const MAX_STOCKS = 20; // ìµœëŒ€ ì¢…ëª© ìˆ˜
      
      if (list.length === 0) {
        currentDiv.innerHTML = '<div class="hint" style="text-align:center; padding:40px; color:#6c757d; font-size:1.05em;">í˜„ì¬ ì„¹í„°ì— ë“±ë¡ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì¢…ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>';
        return;
      }
      
      // ì´ ê°œìˆ˜ í‘œì‹œ
      const totalCount = list.length;
      const displayList = list.slice(0, MAX_STOCKS); // ìµœëŒ€ 20ê°œë§Œ í‘œì‹œ
      
      let html = '';
      
      // ì¢…ëª© ëª©ë¡ í‘œì‹œ (ìµœëŒ€ 20ê°œ, ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ - í•œ ì¤„ì— 5ê°œ)
      displayList.forEach((ticker, index) => {
        html += `
          <div style="display:flex; flex-direction:column; gap:6px; padding:10px; background:white; border:2px solid #667eea; border-radius:8px; transition:all 0.2s; min-height:75px;" 
               onmouseover="this.style.boxShadow='0 2px 8px rgba(102,126,234,0.3)'" 
               onmouseout="this.style.boxShadow='none'">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:4px;">
              <span style="font-weight:bold; font-size:1em; color:#333; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${ticker}</span>
              <span style="color:#667eea; font-size:0.75em; background:#e9ecef; padding:2px 6px; border-radius:4px; white-space:nowrap; flex-shrink:0;">ë“±ë¡</span>
            </div>
            <button class="btn btn-secondary" onclick="toggleStock('${ticker}', true)" style="padding:6px 10px; font-size:0.85em; width:100%;">
              ì œê±°
            </button>
          </div>
        `;
      });
      
      currentDiv.innerHTML = html;
      
      // ì´ ê°œìˆ˜ ë° ì œí•œ í‘œì‹œ (ê·¸ë¦¬ë“œ ë°”ê¹¥ì— í‘œì‹œ)
      // ê¸°ì¡´ countInfoê°€ ìˆìœ¼ë©´ ì œê±°
      const existingCountInfo = currentDiv.parentNode?.querySelector('.current-stocks-count-info');
      if (existingCountInfo) {
        existingCountInfo.remove();
      }
      
      const countInfo = document.createElement('div');
      countInfo.className = 'current-stocks-count-info';
      countInfo.style.cssText = 'margin-bottom: 10px; font-size: 0.95em; text-align: center; font-weight: 600;';
      
      if (totalCount > MAX_STOCKS) {
        countInfo.style.cssText += 'padding:8px 12px; background:#fff3cd; border:1px solid #ffc107; border-radius:6px; color:#856404;';
        countInfo.textContent = `âš ï¸ ì´ ${totalCount}ê°œ ì¢…ëª© ì¤‘ ${MAX_STOCKS}ê°œë§Œ í‘œì‹œ (ìµœëŒ€ ${MAX_STOCKS}ê°œê¹Œì§€ë§Œ ë“±ë¡ ê°€ëŠ¥)`;
      } else {
        countInfo.style.cssText += 'padding:8px 12px; background:#e9ecef; border-radius:6px; color:#495057;';
        countInfo.textContent = `ì´ ${totalCount}ê°œ ì¢…ëª© (ìµœëŒ€ ${MAX_STOCKS}ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥)`;
      }
      
      // ë¶€ëª¨ ìš”ì†Œì— ì‚½ì… (ê·¸ë¦¬ë“œ ìœ„ì—)
      if (currentDiv.parentNode) {
        currentDiv.parentNode.insertBefore(countInfo, currentDiv);
      }
    }
    
    function renderManageList() {
      // ê²€ìƒ‰ ì´ˆê¸°í™” ë° í˜„ì¬ ì¢…ëª© ëª©ë¡ í‘œì‹œ
      renderCurrentStocksList();
      const searchInput = document.getElementById('manageSearch');
      if (searchInput) {
        searchInput.value = '';
      }
      document.getElementById('manageList').innerHTML = '<div class="hint">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ì¢…ëª©ì„ ê²€ìƒ‰í•˜ì„¸ìš”.</div>';
    }


    async function saveManagedStocks() {
      const idx = parseInt(document.getElementById('manageSector').value);
      if (!Number.isInteger(idx) || !sectors[idx]) { closeManageStocks(); return; }
      
      const MAX_STOCKS = 20; // ìµœëŒ€ ì¢…ëª© ìˆ˜
      
      // í˜„ì¬ ì„¹í„°ì˜ ì¢…ëª© ëª©ë¡ ì •ë¦¬ ë° ê²€ì¦
      const currentStocks = sectors[idx].stocks || [];
      const next = currentStocks
        .map(t => (t || '').trim().toUpperCase())
        .filter(Boolean)
        .filter(t => /^[A-Z0-9.-]{1,8}$/.test(t));
      const unique = Array.from(new Set(next));
      
      // 20ê°œ ì œí•œ ì ìš©
      if (unique.length > MAX_STOCKS) {
        alert(`âš ï¸ ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ìµœëŒ€ ${MAX_STOCKS}ê°œê¹Œì§€ë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\ní˜„ì¬ ë“±ë¡ëœ ì¢…ëª©: ${unique.length}ê°œ\nì²˜ìŒ ${MAX_STOCKS}ê°œë§Œ ì €ì¥ë©ë‹ˆë‹¤.`);
        sectors[idx].stocks = unique.slice(0, MAX_STOCKS);
      } else {
        sectors[idx].stocks = unique;
      }

      // ì„¹í„° ì˜¤ë²„ë¼ì´ë“œ ì €ì¥ (localStorage)
      try {
        const raw = localStorage.getItem(SECTOR_OVERRIDES_KEY);
        const map = raw ? JSON.parse(raw) : {};
        map[idx] = unique;
        localStorage.setItem(SECTOR_OVERRIDES_KEY, JSON.stringify(map));

        // ì„œë²„ì—ë„ ì €ì¥ (ë™ê¸°í™”)
        const serverData = {
          sectorOverrides: map,
          customStocks: JSON.parse(localStorage.getItem(CUSTOM_STOCKS_KEY) || '{}')
        };
        const saved = await saveStocksToServer(serverData);
        if (saved) {
          console.log('ì„œë²„ì— ì¢…ëª© ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          console.warn('ì„œë²„ ì €ì¥ ì‹¤íŒ¨, localStorageì—ë§Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('ì¢…ëª© ì €ì¥ ì‹¤íŒ¨:', error);
      }

      rebuildAllStocks();
      renderSectorList();
      if (currentSector === 'all' || currentSector === idx) {
        loadNews();
      }
      closeManageStocks();
    }

    // ì„¹í„° ëª©ë¡ ë Œë”ë§
    function renderSectorList() {
      const sectorList = document.getElementById('sectorList');
      const sectorFilter = document.getElementById('sectorFilter');
      const notifSectorSelect = document.getElementById('notifSector');
      const sectorChips = document.getElementById('sectorChips');
      
      // í•˜ë…¸ì´ ì‹œê°„ ê¸°ì¤€ ì „ì¼ ë‰´ìŠ¤ ê¸°ë°˜ ì¹´ìš´íŠ¸ ê³„ì‚° (ì „ë‚  ì˜¤ì „ 10ì‹œ ~ ê¸ˆì¼ ì˜¤ì „ 10ì‹œ)
      const sectorCounts = sectors.map(sector => {
        if (!Array.isArray(lastNews)) return 0;
        return lastNews.filter(n => {
          // ì „ì¼ ê¸°ì¤€ ë‰´ìŠ¤ì¸ì§€ í™•ì¸
          if (!isHanoiTodayNews(n)) return false;
          // í•´ë‹¹ ì„¹í„°ì˜ ì¢…ëª©ì¸ì§€ í™•ì¸
          return sector.stocks.includes(n.ticker);
        }).length;
      });
      const totalCount = sectorCounts.reduce((a, b) => a + b, 0);
      let html = `<li class="sector-item ${currentSector==='all' ? 'active' : ''}" onclick="selectSector('all')"><span>ì „ì²´ ì„¹í„°</span><span class="sector-count">${totalCount}</span></li>`;
      let optionsHtml = '<option value="all">ì „ì²´ ì„¹í„°</option>';
      let notifOptionsHtml = '<option value="all">ì „ì²´ ì„¹í„°</option>';
      let chipsHtml = `<div class="sector-chip ${currentSector==='all' ? 'active' : ''}" onclick="selectSector('all')">ì „ì²´<span class="count">${totalCount}</span></div>`;
      
      sectors.forEach((sector, idx) => {
        const newsCount = sectorCounts[idx];
        const activeCls = (currentSector===idx) ? 'active' : '';
        html += `<li class="sector-item ${activeCls}" onclick="selectSector(${idx})">
          <span>${sector.name}</span>
          <span class="sector-count">${newsCount}</span>
        </li>`;
        optionsHtml += `<option value="${idx}">${sector.name}</option>`;
        notifOptionsHtml += `<option value="${idx}">${sector.name}</option>`;
        
        // ëª¨ë°”ì¼ìš© ì¹© ìƒì„± (ì„¹í„°ëª… ê°„ì†Œí™”)
        const shortName = sector.name.split('(')[0].trim();
        chipsHtml += `<div class="sector-chip ${activeCls}" onclick="selectSector(${idx})">${shortName}<span class="count">${newsCount}</span></div>`;
      });
      
      sectorList.innerHTML = html;
      if (sectorFilter) sectorFilter.innerHTML = optionsHtml;
      if (notifSectorSelect) notifSectorSelect.innerHTML = notifOptionsHtml;
      if (sectorChips) sectorChips.innerHTML = chipsHtml;

      // í˜„ì¬ ì„ íƒ ìƒíƒœ ìœ ì§€ ë° ì´ ê°œìˆ˜ ê°±ì‹ 
      if (sectorFilter) sectorFilter.value = currentSector === 'all' ? 'all' : String(currentSector);
      if (notifSectorSelect) notifSectorSelect.value = currentSector === 'all' ? 'all' : String(currentSector);
      // ì´ ì¶”ì  ì¢…ëª© ìˆ˜ëŠ” rebuildAllStocks()ì—ì„œ ì—…ë°ì´íŠ¸ë¨
    }

    // ì„¹í„° ì„ íƒ
    function selectSector(index) {
      const items = document.querySelectorAll('.sector-item');
      const chips = document.querySelectorAll('.sector-chip');
      
      items.forEach(item => item.classList.remove('active'));
      chips.forEach(chip => chip.classList.remove('active'));
      
      if (index === 'all') {
        if (items[0]) items[0].classList.add('active');
        if (chips[0]) chips[0].classList.add('active');
        currentSector = 'all';
        document.getElementById('newsTitle').textContent = 'ì „ì²´ ì„¹í„° ìµœì‹  ë‰´ìŠ¤';
      } else {
        if (items[index + 1]) items[index + 1].classList.add('active');
        if (chips[index + 1]) chips[index + 1].classList.add('active');
        currentSector = index;
        document.getElementById('newsTitle').textContent = sectors[index].name + ' ë‰´ìŠ¤';
      }
      
      // ëª¨ë°”ì¼ì—ì„œ ì„¹í„° ì¹© ìŠ¤í¬ë¡¤ (ì„ íƒëœ ì¹©ì´ ë³´ì´ë„ë¡)
      if (window.innerWidth <= 768 && chips.length > 0) {
        const activeChip = chips[index === 'all' ? 0 : index + 1];
        if (activeChip) {
          activeChip.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
      }
      
      loadNews();
    }

    // ì „ì¼ ê¸°ì¤€ ê°€ì¥ ë‰´ìŠ¤ê°€ ë§ì€ ì„¹í„° ì°¾ê¸°
    function updateTopSector() {
      if (!Array.isArray(lastNews) || lastNews.length === 0) {
        document.getElementById('topSector').textContent = '-';
        return;
      }

      // ì„¹í„°ë³„ ì˜¤ëŠ˜ ë‰´ìŠ¤ ê°œìˆ˜ ê³„ì‚°
      const sectorCounts = sectors.map((sector, idx) => {
        const count = lastNews.filter(n => 
          isHanoiTodayNews(n) && sector.stocks.includes(n.ticker)
        ).length;
        return { index: idx, name: sector.name, count: count };
      });

      // ê°€ì¥ ë§ì€ ë‰´ìŠ¤ë¥¼ ê°€ì§„ ì„¹í„° ì°¾ê¸°
      const topSector = sectorCounts.reduce((max, current) => 
        current.count > max.count ? current : max
      , { index: -1, name: 'ì—†ìŒ', count: 0 });

      // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
      const topSectorEl = document.getElementById('topSector');
      if (topSector.count > 0) {
        topSectorEl.textContent = `${topSector.name} (${topSector.count})`;
      } else {
        topSectorEl.textContent = '-';
      }
    }

    // Google Financeì™€ Yahoo Financeì—ì„œë§Œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    async function fetchRealNews(tickers) {
      const allNews = [];
      
      // ê° í‹°ì»¤ë³„ë¡œ ë‰´ìŠ¤ ê²€ìƒ‰
      const searchPromises = tickers.slice(0, 20).map(async (ticker) => {
        try {
          // Google Financeì™€ Yahoo Financeì—ì„œë§Œ ë‰´ìŠ¤ ìˆ˜ì§‘
          const newsItems = await Promise.allSettled([
            fetchNewsFromGoogleFinance(ticker),
            fetchNewsFromYahooFinance(ticker)
          ]);

          // ëª¨ë“  ê²°ê³¼ë¥¼ í•©ì¹˜ê¸°
          const tickerNews = [];
          newsItems.forEach(result => {
            if (result.status === 'fulfilled' && result.value) {
              tickerNews.push(...result.value);
            }
          });

          return tickerNews;
        } catch (error) {
          console.error(`ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ (${ticker}):`, error);
          return [];
        }
      });

      const results = await Promise.allSettled(searchPromises);
      results.forEach(result => {
        if (result.status === 'fulfilled' && result.value) {
          allNews.push(...result.value);
        }
      });

      // ì¤‘ë³µ ì œê±° ë° ì •ë ¬ (ì œëª© ê¸°ì¤€)
      const uniqueNews = [];
      const seenTitles = new Set();
      allNews.forEach(item => {
        const titleKey = item.title.toLowerCase().trim();
        if (!seenTitles.has(titleKey)) {
          seenTitles.add(titleKey);
          uniqueNews.push(item);
        }
      });

      // ì €ì¥ëœ ë‰´ìŠ¤ì™€ ë¹„êµí•˜ì—¬ ìƒˆ ë‰´ìŠ¤ë§Œ ë°˜í™˜
      const storedNews = loadStoredNews();
      const storedTitles = new Set(storedNews.map(n => n.title.toLowerCase().trim()));
      
      // ìƒˆë¡œ ìƒì„±ëœ ë‰´ìŠ¤ë§Œ í•„í„°ë§ (ì €ì¥ë˜ì§€ ì•Šì€ ë‰´ìŠ¤)
      const newNews = uniqueNews.filter(item => {
        const titleKey = item.title.toLowerCase().trim();
        return !storedTitles.has(titleKey);
      });

      return newNews.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
    }

    // Google News ì œê±°ë¨ - ì§ì ‘ ì†ŒìŠ¤ë§Œ ì‚¬ìš©

    // Google News RSSì—ì„œ ì›ë³¸ URL ì¶”ì¶œ ê°œì„ 
    function extractOriginalUrlFromGoogleNews(description, sourceName, ticker) {
      if (!description) return null;
      
      // ì†ŒìŠ¤ ë„ë©”ì¸ ë§µ (Google Financeì™€ Yahoo Financeë§Œ ì‚¬ìš©)
      const sourceDomains = {
        'Google Finance': ['google.com/finance', 'google.com'],
        'êµ¬ê¸€ íŒŒì´ë‚¸ìŠ¤': ['google.com/finance', 'google.com'],
        'Yahoo Finance': ['finance.yahoo.com', 'yahoo.com'],
        'ì•¼í›„ íŒŒì´ë‚¸ìŠ¤': ['finance.yahoo.com', 'yahoo.com']
      };
      
      const expectedDomains = sourceDomains[sourceName] || [];
      
      // ë°©ë²• 1: description HTMLì—ì„œ href ì¶”ì¶œ (ì—¬ëŸ¬ ë§í¬ í™•ì¸)
      const htmlLinks = description.match(/<a[^>]+href=["']([^"']+)["'][^>]*>/gi);
      if (htmlLinks) {
        for (const htmlLink of htmlLinks) {
          const hrefMatch = htmlLink.match(/href=["']([^"']+)["']/i);
          if (hrefMatch && hrefMatch[1]) {
            let url = hrefMatch[1];
            
            // ìƒëŒ€ ê²½ë¡œ ì²˜ë¦¬
            if (url.startsWith('/')) {
              const domainMatch = description.match(/https?:\/\/([^\/\s"']+)/);
              if (domainMatch) {
                url = `https://${domainMatch[1]}${url}`;
              } else {
                // ì†ŒìŠ¤ ë„ë©”ì¸ ì‚¬ìš©
                if (expectedDomains.length > 0) {
                  url = `https://${expectedDomains[0]}${url}`;
                }
              }
            }
            
            // Google/Yahoo ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ì œê±°
            if (url.includes('news.google.com') || url.includes('google.com') || url.includes('yahoo.com')) {
              // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì›ë³¸ ì¶”ì¶œ ì‹œë„
              const urlParamMatch = url.match(/[?&]url=([^&]+)/);
              if (urlParamMatch) {
                try {
                  const decoded = decodeURIComponent(urlParamMatch[1]);
                  if (decoded && !decoded.includes('news.google.com') && !decoded.includes('google.com')) {
                    url = decoded;
                  }
                } catch (e) {}
              }
            }
            
            // ìœ íš¨í•œ URLì¸ì§€ í™•ì¸ (ì†ŒìŠ¤ ë„ë©”ì¸ í¬í•¨)
            if (url && url.startsWith('http')) {
              const isValidDomain = expectedDomains.some(domain => url.includes(domain));
              if (isValidDomain || expectedDomains.length === 0) {
                if (!url.includes('news.google.com') && !url.includes('google.com') && !url.includes('yahoo.com')) {
                  return url;
                }
              }
            }
          }
        }
      }
      
      // ë°©ë²• 2: description í…ìŠ¤íŠ¸ì—ì„œ URL íŒ¨í„´ ì°¾ê¸°
      const urlPattern = /https?:\/\/[^\s<>"']+/gi;
      const urls = description.match(urlPattern);
      if (urls) {
        for (const url of urls) {
          // URL ì •ë¦¬ (ë‹«ëŠ” íƒœê·¸ë‚˜ íŠ¹ìˆ˜ë¬¸ì ì œê±°)
          const cleanUrl = url.replace(/[<>"')\]}]/g, '').trim();
          
          if (!cleanUrl.includes('news.google.com') && !cleanUrl.includes('google.com') && !cleanUrl.includes('yahoo.com')) {
            // ì†ŒìŠ¤ ë„ë©”ì¸ í™•ì¸
            const isValidDomain = expectedDomains.some(domain => cleanUrl.includes(domain));
            if (isValidDomain || expectedDomains.length === 0) {
              return cleanUrl;
            }
          }
        }
      }
      
      // ì›ë³¸ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° null ë°˜í™˜
      return null;
    }

    // RSS í”¼ë“œ íŒŒì‹± í—¬í¼ í•¨ìˆ˜ (í‹°ì»¤ í•„í„°ë§ í¬í•¨, ì‹¤ì œ ì†ŒìŠ¤ í˜ì´ì§€ ì—°ê²°)
    async function parseRSSFeedWithTicker(url, sourceName, ticker) {
      try {
        const corsProxy = 'https://api.allorigins.win/get?url=';
        const response = await fetch(`${corsProxy}${encodeURIComponent(url)}`, {
          headers: {
            'Accept': 'application/rss+xml, application/xml, text/xml'
          }
        });
        
        if (!response.ok) return [];
        
        const data = await response.json();
        if (!data.contents) return [];

        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(data.contents, 'text/xml');
        const items = xmlDoc.querySelectorAll('item');
        
        const news = [];
        items.forEach((item, index) => {
          const title = item.querySelector('title')?.textContent || '';
          let link = item.querySelector('link')?.textContent || '';
          const pubDate = item.querySelector('pubDate')?.textContent || '';
          const description = item.querySelector('description')?.textContent || '';
          
          if (!title || !link) return;
          
          // í‹°ì»¤ê°€ ì œëª©ì´ë‚˜ ì„¤ëª…ì— í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          const tickerRegex = new RegExp(`\\b${ticker}\\b`, 'i');
          if (!tickerRegex.test(title) && !tickerRegex.test(description)) {
            return; // í‹°ì»¤ê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
          }
          
          // Google Financeì™€ Yahoo Financeë§Œ í—ˆìš©
          if (sourceName === 'Google Finance' || sourceName === 'êµ¬ê¸€ íŒŒì´ë‚¸ìŠ¤') {
            // Google Financeì˜ ê²½ìš° Google News ê²€ìƒ‰ ê²°ê³¼ì—ì„œ Google Finance í˜ì´ì§€ë§Œ í—ˆìš©
            if (link && link.includes('news.google.com')) {
              // descriptionì—ì„œ ì›ë³¸ URL ì¶”ì¶œ ì‹œë„
              const originalUrl = extractOriginalUrlFromGoogleNews(description, sourceName, ticker);
              if (originalUrl && originalUrl.includes('google.com/finance')) {
                link = originalUrl;
              } else {
                // descriptionì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„
                const htmlMatch = description.match(/<a[^>]+href=["']([^"']+)["'][^>]*>/i);
                if (htmlMatch && htmlMatch[1]) {
                  let foundUrl = htmlMatch[1];
                  if (foundUrl.startsWith('/')) {
                    foundUrl = `https://www.google.com${foundUrl}`;
                  }
                  if (foundUrl && foundUrl.includes('google.com/finance')) {
                    link = foundUrl;
                  } else {
                    return; // Google Finance í˜ì´ì§€ê°€ ì•„ë‹ˆë©´ ìŠ¤í‚µ
                  }
                } else {
                  // Google Finance ë‰´ìŠ¤ í˜ì´ì§€ë¡œ ì§ì ‘ ì—°ê²°
                  link = `https://www.google.com/finance/quote/${ticker}:NASDAQ?hl=en`;
                }
              }
            } else if (!link || !link.includes('google.com/finance')) {
              // Google Finance ë§í¬ê°€ ì•„ë‹ˆë©´ ìŠ¤í‚µ (ë˜ëŠ” ì§ì ‘ Google Finance í˜ì´ì§€ë¡œ ì—°ê²°)
              if (!link.includes('google.com')) {
                return;
              }
            }
          } else if (sourceName === 'Yahoo Finance' || sourceName === 'ì•¼í›„ íŒŒì´ë‚¸ìŠ¤') {
            // Yahoo Financeì˜ ê²½ìš° Yahoo Finance ë§í¬ë§Œ í—ˆìš©
            if (link && !link.includes('finance.yahoo.com')) {
              // Yahoo Finance ë‰´ìŠ¤ í˜ì´ì§€ë¡œ ì§ì ‘ ì—°ê²°
              if (link.includes('yahoo.com')) {
                // ì´ë¯¸ Yahoo ë§í¬ì´ì§€ë§Œ finance.yahoo.comì´ ì•„ë‹Œ ê²½ìš°
                link = `https://finance.yahoo.com/quote/${ticker}/news?p=${ticker}`;
              } else {
                return; // Yahoo Finance ë§í¬ê°€ ì•„ë‹ˆë©´ ìŠ¤í‚µ
              }
            } else if (!link) {
              // ë§í¬ê°€ ì—†ìœ¼ë©´ Yahoo Finance ë‰´ìŠ¤ í˜ì´ì§€ë¡œ ì—°ê²°
              link = `https://finance.yahoo.com/quote/${ticker}/news?p=${ticker}`;
            }
          } else {
            // ê¸°íƒ€ ì†ŒìŠ¤ëŠ” ëª¨ë‘ ì œê±° (ì‚¬ìš© ì•ˆ í•¨)
            return;
          }
          
          // ì œëª©ì—ì„œ í‹°ì»¤ ì¶”ì¶œ
          const tickerMatch = title.match(/\b([A-Z]{2,5})\b/);
          const newsTicker = tickerMatch ? tickerMatch[1] : ticker;
          
          const createdAt = pubDate ? new Date(pubDate).getTime() : Date.now() - (index * 60 * 60 * 1000);
          const now = Date.now();
          const diffMs = now - createdAt;
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const timeText = diffHours === 0 ? 'ë°©ê¸ˆ ì „' : `${diffHours}ì‹œê°„ ì „`;
          
          // descriptionì—ì„œ ì‹¤ì œ ë‰´ìŠ¤ ë‚´ìš© ì¶”ì¶œ
          let cleanDescription = (description || '')
            .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '') // ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ì œê±°
            .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '') // ìŠ¤íƒ€ì¼ íƒœê·¸ ì œê±°
            .replace(/<[^>]*>/g, ' ') // HTML íƒœê·¸ ì œê±°
            .replace(/&nbsp;/g, ' ')
            .replace(/&quot;/g, '"')
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&apos;/g, "'")
            .replace(/&mdash;/g, 'â€”')
            .replace(/&ndash;/g, 'â€“')
            .replace(/&hellip;/g, '...')
            .replace(/&[^;]+;/g, ' ') // ê¸°íƒ€ HTML ì—”í‹°í‹° ì œê±°
            .replace(/\s+/g, ' ') // ì—°ì† ê³µë°± ì •ë¦¬
            .trim();
          
          // ì‹¤ì œ ë‰´ìŠ¤ ë‚´ìš©ì´ ì—†ëŠ” ê²½ìš° ìµœì†Œ ë‚´ìš© ìƒì„±
          const cleanTitle = title.replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, ' ').trim();
          
          if (!cleanDescription || cleanDescription.length < 30 || cleanDescription === cleanTitle) {
            // ì‹¤ì œ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì œëª© ê¸°ë°˜ìœ¼ë¡œ ìš”ì•½ ìƒì„±
            cleanDescription = `${cleanTitle}ì— ëŒ€í•œ ${sourceName}ì˜ ìµœì‹  ë‰´ìŠ¤ì…ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ë§í¬ë¥¼ í†µí•´ í™•ì¸í•˜ì„¸ìš”.`;
          }
          
          // ìš”ì•½ ìƒì„± (ìµœëŒ€ 300ì)
          let summary = cleanDescription;
          if (summary.length > 300) {
            // ë¬¸ì¥ ë‹¨ìœ„ë¡œ ìë¥´ê¸° (ë” ìì—°ìŠ¤ëŸ¬ìš´ ìš”ì•½)
            const sentences = summary.match(/[^.!?]+[.!?]+/g) || [summary];
            summary = '';
            for (const sentence of sentences) {
              if ((summary + sentence).length <= 280) {
                summary += sentence;
              } else {
                break;
              }
            }
            if (summary.length < cleanDescription.length) {
              summary += '...';
            }
          }

          // ì „ì²´ ë‚´ìš© ì €ì¥ (ìš”ì•½ë³´ë‹¤ ë” ê¸´ ë‚´ìš©)
          let fullContent = cleanDescription;
          // ë‚´ìš©ì´ ë„ˆë¬´ ì§§ìœ¼ë©´ ìš”ì•½ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì •
          if (fullContent.length < 100) {
            fullContent = summary;
          }

          news.push({
            ticker: newsTicker,
            title: cleanTitle,
            summary: summary,
            content: fullContent, // ì „ì²´ ë‰´ìŠ¤ ë‚´ìš©
            source: sourceName,
            time: timeText,
            formattedTime: formatDateTime(createdAt),
            url: link, // ì‹¤ì œ ì†ŒìŠ¤ í˜ì´ì§€ URL
            createdAt: createdAt
          });
        });
        return news;
      } catch (error) {
        console.error(`${sourceName} RSS íŒŒì‹± ì‹¤íŒ¨:`, error);
        return [];
      }
    }

    // RSS í”¼ë“œ íŒŒì‹± í—¬í¼ í•¨ìˆ˜
    async function parseRSSFeed(url, sourceName, ticker) {
      try {
        const corsProxy = 'https://api.allorigins.win/get?url=';
        const response = await fetch(`${corsProxy}${encodeURIComponent(url)}`, {
          headers: {
            'Accept': 'application/rss+xml, application/xml, text/xml'
          }
        });
        
        if (!response.ok) return [];
        
        const data = await response.json();
        if (!data.contents) return [];

        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(data.contents, 'text/xml');
        const items = xmlDoc.querySelectorAll('item');
        
        const news = [];
        items.forEach((item, index) => {
          const title = item.querySelector('title')?.textContent || '';
          let link = item.querySelector('link')?.textContent || '';
          const pubDate = item.querySelector('pubDate')?.textContent || '';
          const description = item.querySelector('description')?.textContent || '';
          
          if (!title || !link) return;
          
          // Google/Yahoo ë§í¬ëŠ” ëª¨ë‘ ì œê±°í•˜ê³  ì§ì ‘ ì†ŒìŠ¤ë¡œ ì—°ê²°
          if (!link || link.includes('news.google.com') || link.includes('google.com') || link.includes('yahoo.com')) {
            // ì†ŒìŠ¤ë³„ ê¸°ë³¸ ë‰´ìŠ¤ í˜ì´ì§€ URL ìƒì„±
            const tickerMatch = title.match(/\b([A-Z]{2,5})\b/);
            const newsTicker = tickerMatch ? tickerMatch[1] : ticker;
            
            if (sourceName === 'CNBC') {
              link = `https://www.cnbc.com/quotes/${newsTicker}`;
            } else if (sourceName === 'MarketWatch') {
              link = `https://www.marketwatch.com/investing/stock/${newsTicker}`;
            } else if (sourceName === 'Reuters Business' || sourceName === 'Reuters') {
              link = `https://www.reuters.com/markets/companies/${newsTicker}`;
            } else if (sourceName === 'Wall Street Journal') {
              link = `https://www.wsj.com/market-data/quotes/${newsTicker}`;
            } else if (sourceName === 'Business Insider') {
              link = `https://markets.businessinsider.com/stocks/${newsTicker}-stock`;
            } else if (sourceName === 'Seeking Alpha') {
              link = `https://seekingalpha.com/symbol/${newsTicker}/news`;
            } else if (sourceName === 'TradingView') {
              link = `https://www.tradingview.com/symbols/${newsTicker}/news/`;
            } else if (sourceName === 'Investing.com') {
              link = `https://www.investing.com/equities/${newsTicker.toLowerCase()}-news`;
            } else if (sourceName === 'TheStreet') {
              link = `https://www.thestreet.com/quote/${newsTicker}`;
            } else {
              // ê¸°ë³¸ê°’: CNBCë¡œ ì—°ê²°
              link = `https://www.cnbc.com/quotes/${newsTicker}`;
            }
          }
          
          // ì œëª©ì—ì„œ í‹°ì»¤ ì¶”ì¶œ
          const tickerMatch = title.match(/\b([A-Z]{2,5})\b/);
          const newsTicker = tickerMatch ? tickerMatch[1] : ticker;
          
          const createdAt = pubDate ? new Date(pubDate).getTime() : Date.now() - (index * 60 * 60 * 1000);
          const now = Date.now();
          const diffMs = now - createdAt;
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const timeText = diffHours === 0 ? 'ë°©ê¸ˆ ì „' : `${diffHours}ì‹œê°„ ì „`;

          news.push({
            ticker: newsTicker,
            title: title.replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, ' ').trim(),
            summary: (description || title).replace(/<[^>]*>/g, '').replace(/&[^;]+;/g, ' ').substring(0, 200).trim(),
            source: sourceName,
            time: timeText,
            formattedTime: formatDateTime(createdAt),
            url: link,
            createdAt: createdAt
          });
        });
        return news;
      } catch (error) {
        console.error(`${sourceName} RSS íŒŒì‹± ì‹¤íŒ¨:`, error);
        return [];
      }
    }

    // Yahoo Finance ì œê±°ë¨ - ì§ì ‘ ì†ŒìŠ¤ë§Œ ì‚¬ìš©

    // í‹°ì»¤ë³„ ë‰´ìŠ¤ ì„¤ëª… í…œí”Œë¦¿
    function getNewsSummary(ticker, sourceName) {
      const summaries = [
        `${ticker} ì£¼ê°€ ì›€ì§ì„ê³¼ ì‹œì¥ ë¶„ì„ì„ ${sourceName}ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìµœì‹  ì‹¤ì , ì• ë„ë¦¬ìŠ¤íŠ¸ ë¦¬í¬íŠ¸, ì—…ê³„ ë™í–¥ì„ ì¢…í•©ì ìœ¼ë¡œ ì œê³µí•©ë‹ˆë‹¤.`,
        `${sourceName}ì—ì„œ ${ticker}ì˜ ìµœì‹  ì¬ë¬´ ì •ë³´, ì£¼ê°€ ë³€ë™, ê±°ë˜ëŸ‰ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì„¸ìš”. ì „ë¬¸ê°€ ì˜ê²¬ê³¼ ì‹œì¥ ì „ë§ë„ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤.`,
        `${ticker}ì— ëŒ€í•œ ìµœì‹  ë‰´ìŠ¤ì™€ ë¶„ì„ì„ ${sourceName}ì—ì„œ í™•ì¸í•˜ì„¸ìš”. ì‹¤ì  ë°œí‘œ, ì „ëµ ë°œí‘œ, íŒŒíŠ¸ë„ˆì‹­ ì†Œì‹ ë“± ì¤‘ìš”í•œ ì •ë³´ë¥¼ ë¹ ë¥´ê²Œ ì œê³µí•©ë‹ˆë‹¤.`,
        `${sourceName}ì—ì„œ ${ticker}ì˜ ê¸°ìˆ ì  ë¶„ì„, ì°¨íŠ¸ íŒ¨í„´, íˆ¬ì ì „ë¬¸ê°€ì˜ ì˜ê²¬ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹¤ì‹œê°„ ì‹œì¥ ë°ì´í„°ì™€ í•¨ê»˜ ì œê³µë©ë‹ˆë‹¤.`,
        `${ticker}ì˜ ìµœê·¼ ì„±ê³¼ì™€ ë¯¸ë˜ ì „ë§ì— ëŒ€í•œ ìƒì„¸í•œ ë¶„ì„ì„ ${sourceName}ì—ì„œ ì œê³µí•©ë‹ˆë‹¤. ì—…ê³„ ë™í–¥ê³¼ ê²½ìŸì‚¬ ë¹„êµ ì •ë³´ë„ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`
      ];
      return summaries[Math.floor(Math.random() * summaries.length)];
    }

    // Google Financeì—ì„œ ë‰´ìŠ¤ ê²€ìƒ‰
    async function fetchNewsFromGoogleFinance(ticker) {
      try {
        // Google FinanceëŠ” ì§ì ‘ RSS í”¼ë“œë¥¼ ì œê³µí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ Google News ê²€ìƒ‰ ì‚¬ìš©
        // Google Finance í˜ì´ì§€ì—ì„œ ì–¸ê¸‰ëœ ë‰´ìŠ¤ ê²€ìƒ‰
        const url = `https://news.google.com/rss/search?q=${encodeURIComponent(`${ticker} "google.com/finance"`)}&hl=en-US&gl=US&ceid=US:en&when=7d`;
        const news = await parseRSSFeedWithTicker(url, 'êµ¬ê¸€ íŒŒì´ë‚¸ìŠ¤', ticker);
        
        // ìƒˆ ë‰´ìŠ¤ë§Œ í•„í„°ë§ (ìµœê·¼ 48ì‹œê°„ ì´ë‚´, ì €ì¥ëœ ë‰´ìŠ¤ ì œì™¸)
        const storedNews = loadStoredNews();
        const storedTitles = new Set(storedNews.map(n => n.title.toLowerCase().trim()));
        
        const now = Date.now();
        const fortyEightHoursAgo = now - (NEWS_RETENTION_HOURS * 60 * 60 * 1000);
        
        // Google Finance í˜ì´ì§€ ë§í¬ë§Œ í•„í„°ë§
        const filteredNews = news.filter(item => {
          const titleKey = item.title.toLowerCase().trim();
          // 48ì‹œê°„ ì´ë‚´ì´ê³ , ì €ì¥ë˜ì§€ ì•Šì€ ìƒˆ ë‰´ìŠ¤ë§Œ
          return item.createdAt >= fortyEightHoursAgo && !storedTitles.has(titleKey);
        });
        
        return filteredNews;
      } catch (error) {
        console.error(`Google Finance ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ (${ticker}):`, error);
        return [];
      }
    }

    // Yahoo Financeì—ì„œ ë‰´ìŠ¤ ê²€ìƒ‰
    async function fetchNewsFromYahooFinance(ticker) {
      try {
        // Yahoo Finance RSS í”¼ë“œ ì‚¬ìš©
        const rssUrl = `https://feeds.finance.yahoo.com/rss/2.0/headline?s=${ticker}&region=US&lang=en-US`;
        const news = await parseRSSFeedWithTicker(rssUrl, 'ì•¼í›„ íŒŒì´ë‚¸ìŠ¤', ticker);
        
        // ìƒˆ ë‰´ìŠ¤ë§Œ í•„í„°ë§ (ìµœê·¼ 48ì‹œê°„ ì´ë‚´, ì €ì¥ëœ ë‰´ìŠ¤ ì œì™¸)
        const storedNews = loadStoredNews();
        const storedTitles = new Set(storedNews.map(n => n.title.toLowerCase().trim()));
        
        const now = Date.now();
        const fortyEightHoursAgo = now - (NEWS_RETENTION_HOURS * 60 * 60 * 1000);
        
        return news.filter(item => {
          const titleKey = item.title.toLowerCase().trim();
          // 48ì‹œê°„ ì´ë‚´ì´ê³ , ì €ì¥ë˜ì§€ ì•Šì€ ìƒˆ ë‰´ìŠ¤ë§Œ
          return item.createdAt >= fortyEightHoursAgo && !storedTitles.has(titleKey);
        });
      } catch (error) {
        console.error(`Yahoo Finance ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ (${ticker}):`, error);
        return [];
      }
    }

    // ê¸°ì¡´ ì†ŒìŠ¤ í•¨ìˆ˜ë“¤ ì œê±°ë¨ - Google Financeì™€ Yahoo Financeë§Œ ì‚¬ìš©

    // ë‰´ìŠ¤ ìƒì„± (ì‹¤ì œ ì†ŒìŠ¤ + í´ë°±)
    async function generateRealNews() {
      let stocksToShow = [];
      if (currentSector === 'all') {
        stocksToShow = allStocks.sort(() => 0.5 - Math.random()).slice(0, 10);
      } else {
        stocksToShow = sectors[currentSector].stocks.slice(0, 20);
      }

      if (currentSearch) {
        stocksToShow = stocksToShow.filter(stock => 
          stock.toLowerCase().includes(currentSearch.toLowerCase())
        );
      }

      if (stocksToShow.length === 0) return [];

      // ì‹¤ì œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹œë„
      try {
        const realNews = await fetchRealNews(stocksToShow);
        if (realNews.length > 0) {
          return realNews;
        }
      } catch (error) {
        console.error('ì‹¤ì œ ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', error);
      }

      // í´ë°±: ê° ë‰´ìŠ¤ ì†ŒìŠ¤ì˜ ì§ì ‘ ë§í¬ ìƒì„± (Google/Yahoo ì œì™¸)
      const fallbackNews = [];
      const sources = [
        { name: "CNBC", url: (t) => `https://www.cnbc.com/quotes/${t}` },
        { name: "MarketWatch", url: (t) => `https://www.marketwatch.com/investing/stock/${t}` },
        { name: "Reuters Business", url: (t) => `https://www.reuters.com/markets/companies/${t}` },
        { name: "Wall Street Journal", url: (t) => `https://www.wsj.com/market-data/quotes/${t}` },
        { name: "Business Insider", url: (t) => `https://markets.businessinsider.com/stocks/${t}-stock` },
        { name: "Seeking Alpha", url: (t) => `https://seekingalpha.com/symbol/${t}/news` },
        { name: "TradingView", url: (t) => `https://www.tradingview.com/symbols/${t}/news/` },
        { name: "Investing.com", url: (t) => `https://www.investing.com/equities/${t.toLowerCase()}-news` },
        { name: "TheStreet", url: (t) => `https://www.thestreet.com/quote/${t}` }
      ];

      // ê° í‹°ì»¤ë³„ë¡œ ê° ì†ŒìŠ¤ì˜ ì§ì ‘ ë§í¬ ìƒì„±
      stocksToShow.forEach((ticker) => {
        sources.forEach((source) => {
          const createdAt = Date.now() - (Math.floor(Math.random() * 48) * 60 * 60 * 1000);
          const now = Date.now();
          const diffMs = now - createdAt;
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const timeText = diffHours === 0 ? 'ë°©ê¸ˆ ì „' : `${diffHours}ì‹œê°„ ì „`;

          fallbackNews.push({
          ticker: ticker,
            title: `${ticker} ìµœì‹  ë‰´ìŠ¤ ë° ë¶„ì„ - ${source.name}`,
            summary: getNewsSummary(ticker, source.name),
            source: source.name,
            time: timeText,
            formattedTime: formatDateTime(createdAt),
            url: source.url(ticker),
          createdAt: createdAt
          });
        });
      });

      return fallbackNews.sort((a, b) => b.createdAt - a.createdAt).slice(0, 100);
    }

    // ë‰´ìŠ¤ ë¡œë“œ
    function loadNews() {
      const newsGrid = document.getElementById('newsGrid');
      newsGrid.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

      setTimeout(async () => {
        // ì €ì¥ëœ ë‰´ìŠ¤ ë¡œë“œ
        let storedNews = loadStoredNews();
        
        // ë²ˆì—­ ê¸°ëŠ¥ ë¹„í™œì„±í™” - ì›ë¬¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        
        // ìƒˆ ë‰´ìŠ¤ ìƒì„± (ì‹¤ì œ ì†ŒìŠ¤ì—ì„œ)
        const newsGrid = document.getElementById('newsGrid');
        if (newsGrid) {
          newsGrid.innerHTML = '<div class="loading"><div class="spinner"></div><p>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';
        }
        const newNews = await generateRealNews();
        
        // ë²ˆì—­í•˜ì§€ ì•Šê³  ì›ë¬¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        var translatedNewNews = newNews || [];
        
        // ê¸°ì¡´ ë‰´ìŠ¤ì™€ ìƒˆ ë‰´ìŠ¤ ë³‘í•©
        const mergedNews = mergeNews(storedNews, translatedNewNews);
        
        // 48ì‹œê°„ ì´ìƒ ëœ ë‰´ìŠ¤ ì œê±°
        const filteredNews = filterOldNews(mergedNews);
        
        // í•„í„°ë§ëœ ë‰´ìŠ¤ ì €ì¥
        saveStoredNews(filteredNews);
        
        // ì„ íƒëœ ì„¹í„°ì— ë”°ë¥¸ ë‰´ìŠ¤ í•„í„°ë§ (í•´ë‹¹ ì„¹í„°ì˜ í‹°ì»¤ë§Œ)
        let sectorFilteredNews = filteredNews;
        if (currentSector !== 'all') {
          const selectedSectorStocks = sectors[currentSector].stocks;
          sectorFilteredNews = filteredNews.filter(item => 
            selectedSectorStocks.includes(item.ticker)
          );
        }
        
        // 48ì‹œê°„ ì´ë‚´ ë‰´ìŠ¤ë§Œ í•„í„°ë§ (ì¶”ê°€ í™•ì¸)
        const now = Date.now();
        const retentionMs = NEWS_RETENTION_HOURS * 60 * 60 * 1000;
        sectorFilteredNews = sectorFilteredNews.filter(item => {
          if (!item.createdAt) return false;
          return (now - item.createdAt) < retentionMs;
        });
        
        // ê²€ìƒ‰ì–´ í•„í„°ë§ (ìˆëŠ” ê²½ìš°)
        if (currentSearch) {
          const searchLower = currentSearch.toLowerCase();
          sectorFilteredNews = sectorFilteredNews.filter(item =>
            item.ticker.toLowerCase().includes(searchLower) ||
            item.title.toLowerCase().includes(searchLower) ||
            (item.summary && item.summary.toLowerCase().includes(searchLower))
          );
        }
        
        lastNews = filteredNews; // ì „ì²´ ë‰´ìŠ¤ëŠ” ìœ ì§€ (í†µê³„ ë° ì‚¬ì´ë“œë°”ìš©)
        displayedNews = sectorFilteredNews; // í˜„ì¬ í‘œì‹œí•  ë‰´ìŠ¤ (í•„í„°ë§ëœ ë‰´ìŠ¤)
        
        if (displayedNews.length === 0) {
          newsGrid.innerHTML = `
            <div class="no-news">
              <div class="no-news-icon">ğŸ“°</div>
              <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
              <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>
            </div>
          `;
          return;
        }
        
        currentPage = 1;
        renderNewsList();
        
        const todayCount = filteredNews.filter(item => isHanoiTodayNews(item)).length;
        document.getElementById('todayNews').textContent = todayCount;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

        // ì „ì¼ ê¸°ì¤€ ê°€ì¥ ë‰´ìŠ¤ê°€ ë§ì€ ì„¹í„° ì—…ë°ì´íŠ¸
        updateTopSector();

        handleNotifications(filteredNews);
        // ì‚¬ì´ë“œë°” ì„¹í„°ë³„ ë‰´ìŠ¤ ê°œìˆ˜ ê°±ì‹ 
        renderSectorList();
        // ìŠ¤í¬ë¡¤ íƒ€ê²Ÿì„ ë‰´ìŠ¤ ì»¨í…Œì´ë„ˆë¡œ ì„¤ì •
        scrollContainer = document.querySelector('.news-container');
        if (scrollContainer && !scrollHandlerAttached) {
          scrollContainer.addEventListener('scroll', handleScrollLoadMore, { passive: true });
          scrollHandlerAttached = true;
        }
      }, 800);
    }

    // ë‰´ìŠ¤ ë‚´ìš© í† ê¸€ í•¨ìˆ˜
    function toggleNewsContent(contentId) {
      const contentDiv = document.getElementById(contentId);
      if (!contentDiv) return;
      
      // í† ê¸€ ë²„íŠ¼ ì°¾ê¸° (contentDiv ë‹¤ìŒ í˜•ì œ ìš”ì†Œ)
      const toggleBtn = contentDiv.nextElementSibling;
      
      if (toggleBtn && toggleBtn.classList.contains('news-content-toggle')) {
        if (contentDiv.style.display === 'none' || !contentDiv.style.display) {
          contentDiv.style.display = 'block';
          toggleBtn.textContent = 'ë‚´ìš© ì ‘ê¸°';
        } else {
          contentDiv.style.display = 'none';
          toggleBtn.textContent = 'ì „ì²´ ë‚´ìš© ë³´ê¸°';
        }
      }
    }

    function renderNewsList() {
      const newsGrid = document.getElementById('newsGrid');
      const limit = Math.min(currentPage * PAGE_SIZE, displayedNews.length);
      let html = '';
      for (let i = 0; i < limit; i++) {
        const item = displayedNews[i];
        // URL ì•ˆì „ ì²˜ë¦¬
        const newsUrl = item.url || '#';
        const safeUrl = newsUrl.replace(/'/g, '%27').replace(/"/g, '%22');
        const safeTitle = (item.title || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        const safeSummary = (item.summary || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        const safeContent = (item.content || item.summary || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/\n/g, '<br>');
        const contentId = `news-content-${i}`;
        const hasContent = (item.content && item.content.length > (item.summary || '').length) || false;
        
        // ë‰´ìŠ¤ ì¹´ë“œ í´ë¦­ í•¸ë“¤ëŸ¬ (ê° ì•„ì´í…œë³„ë¡œ ê³ ìœ í•œ í•¨ìˆ˜ ìƒì„±)
        const openNewsUrl = `(function(){window.open('${safeUrl}', '_blank', 'noopener,noreferrer');})()`;
        
        html += `
          <div class="news-card">
            <div class="news-meta">
              <span class="news-ticker">${item.ticker || ''}</span>
              <span class="news-time">ğŸ•’ ${item.time || ''} (${item.formattedTime || formatDateTime(item.createdAt) || ''})</span>
            </div>
            <h3 class="news-title" onclick="${openNewsUrl}" style="cursor: pointer;">${safeTitle}</h3>
            <p class="news-summary">${safeSummary}</p>
            ${hasContent ? `
            <div id="${contentId}" class="news-content" style="display: none;">
              ${safeContent}
            </div>
            <span class="news-content-toggle" onclick="toggleNewsContent('${contentId}')">
              ì „ì²´ ë‚´ìš© ë³´ê¸°
            </span>
            ` : ''}
            <div class="news-source">
              <span class="source-name">${item.source || ''}</span>
              <a href="${safeUrl}" class="read-more" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation(); window.open('${safeUrl}', '_blank', 'noopener,noreferrer'); return false;">
                ìì„¸íˆ ë³´ê¸° â†’
              </a>
            </div>
          </div>
        `;
      }
      newsGrid.innerHTML = html;
    }

    function handleScrollLoadMore() {
      const el = scrollContainer || document.querySelector('.news-container');
      if (!el) return;
      const nearBottom = (el.scrollTop + el.clientHeight) >= (el.scrollHeight - 120);
      if (!nearBottom) return;
      const maxPage = Math.ceil(displayedNews.length / PAGE_SIZE) || 1;
      if (currentPage >= maxPage) return;
      currentPage += 1;
      renderNewsList();
    }

    // ===== ì•Œë¦¼ ë¡œì§ =====
    function openNotifications() {
      ensurePrefsLoaded();
      const backdrop = document.getElementById('notifBackdrop');
      const enabledEl = document.getElementById('notifEnabled');
      const notifyDesktop = document.getElementById('notifyDesktop');
      const notifySound = document.getElementById('notifySound');
      const notifyVibrate = document.getElementById('notifyVibrate');
      const notifyOnlyNew = document.getElementById('notifyOnlyNew');
      const notifSectorSelect = document.getElementById('notifSector');
      const notifTickers = document.getElementById('notifTickers');
      const hint = document.getElementById('notifPermHint');

      enabledEl.checked = notificationPrefs.enabled;
      notifyDesktop.checked = notificationPrefs.types.desktop;
      notifySound.checked = notificationPrefs.types.sound;
      notifyVibrate.checked = notificationPrefs.types.vibrate;
      notifyOnlyNew.checked = notificationPrefs.onlyNew;
      notifSectorSelect.value = notificationPrefs.sector;
      notifTickers.value = (notificationPrefs.tickers || []).join(', ');

      hint.textContent = Notification && Notification.permission ? `ê¶Œí•œ: ${Notification.permission}` : '';

      backdrop.style.display = 'flex';
    }


    function closeNotifications() {
      document.getElementById('notifBackdrop').style.display = 'none';
    }

    function backdropClick(e) {
      if (e.target.id === 'notifBackdrop') {
        closeNotifications();
      }
    }

    function ensurePrefsLoaded() {
      if (notificationPrefs) return;
      const saved = localStorage.getItem('news_notif_prefs');
      notificationPrefs = saved ? JSON.parse(saved) : {
        enabled: false,
        types: { desktop: true, sound: false, vibrate: false },
        sector: 'all',
        tickers: [],
        onlyNew: true
      };
      const storedIds = localStorage.getItem('news_notified_ids');
      if (storedIds) {
        try {
          JSON.parse(storedIds).forEach(id => lastNotifiedIds.add(id));
        } catch {}
      }
    }

    function saveNotificationPrefs() {
      ensurePrefsLoaded();
      const enabled = document.getElementById('notifEnabled').checked;
      const types = {
        desktop: document.getElementById('notifyDesktop').checked,
        sound: document.getElementById('notifySound').checked,
        vibrate: document.getElementById('notifyVibrate').checked
      };
      const sector = document.getElementById('notifSector').value;
      const tickers = document.getElementById('notifTickers').value
        .split(',')
        .map(s => s.trim().toUpperCase())
        .filter(Boolean);
      const onlyNew = document.getElementById('notifyOnlyNew').checked;

      notificationPrefs = { enabled, types, sector, tickers, onlyNew };
      localStorage.setItem('news_notif_prefs', JSON.stringify(notificationPrefs));

      if (enabled && types.desktop) {
        requestNotificationPermission();
      }

      closeNotifications();
    }

    function requestNotificationPermission() {
      if (!('Notification' in window)) return;
      if (Notification.permission === 'default') {
        Notification.requestPermission().then(() => {
          const hint = document.getElementById('notifPermHint');
          if (hint) hint.textContent = `ê¶Œí•œ: ${Notification.permission}`;
        });
      }
    }

    function canDesktopNotify() {
      return ('Notification' in window) && Notification.permission === 'granted';
    }

    function matchesFilters(item) {
      // ì„¹í„° í•„í„°
      if (notificationPrefs.sector !== 'all') {
        const sectorIdx = parseInt(notificationPrefs.sector);
        const inSector = sectors[sectorIdx].stocks.includes(item.ticker);
        if (!inSector) return false;
      }
      // í‹°ì»¤ í•„í„°
      if (notificationPrefs.tickers && notificationPrefs.tickers.length > 0) {
        if (!notificationPrefs.tickers.includes(item.ticker.toUpperCase())) return false;
      }
      return true;
    }

    function itemId(item) {
      return `${item.ticker}|${item.title}|${item.createdAt || ''}`;
    }

    function handleNotifications(news) {
      ensurePrefsLoaded();
      if (!notificationPrefs.enabled) return;

      const toNotify = [];
      news.forEach(item => {
        if (!matchesFilters(item)) return;
        const id = itemId(item);
        const isNew = item.time === '0ì‹œê°„ ì „' || (item.createdAt && Date.now() - item.createdAt < 60000);
        if (notificationPrefs.onlyNew) {
          if (!isNew) return;
        }
        if (lastNotifiedIds.has(id)) return;
        toNotify.push({ id, item });
      });

      if (toNotify.length === 0) return;

      const notifiedIds = [];
      toNotify.forEach(({ id, item }) => {
        if (notificationPrefs.types.desktop && canDesktopNotify()) {
          try {
            const n = new Notification(`ğŸ“° ${item.ticker} ìµœì‹  ë‰´ìŠ¤`, {
              body: item.title,
              icon: undefined,
              tag: id
            });
            n.onclick = () => {
              window.focus();
              window.open(item.url, '_blank');
            };
          } catch {}
        }

        if (notificationPrefs.types.sound) {
          try {
            const audio = document.getElementById('notifSound');
            if (audio) {
              audio.currentTime = 0;
              audio.play().catch(() => {});
            }
          } catch {}
        }

        if (notificationPrefs.types.vibrate && 'vibrate' in navigator) {
          try { navigator.vibrate([80, 40, 80]); } catch {}
        }

        lastNotifiedIds.add(id);
        notifiedIds.push(id);
      });

      // ì €ì¥í•˜ì—¬ ìƒˆë¡œê³ ì¹¨ í›„ ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€ (ìµœê·¼ 500ê°œê¹Œì§€ë§Œ ìœ ì§€)
      const existing = Array.from(lastNotifiedIds);
      if (existing.length > 500) {
        const trimmed = existing.slice(existing.length - 500);
        lastNotifiedIds = new Set(trimmed);
        localStorage.setItem('news_notified_ids', JSON.stringify(trimmed));
      } else {
        localStorage.setItem('news_notified_ids', JSON.stringify(existing));
      }
    }

    // ë‰´ìŠ¤ ê²€ìƒ‰
    function searchNews() {
      currentSearch = document.getElementById('searchInput').value;
      const sectorValue = document.getElementById('sectorFilter').value;
      
      if (sectorValue !== 'all') {
        selectSector(parseInt(sectorValue));
      } else {
        loadNews();
      }

      updateFilterTags();
    }

    // í•„í„° íƒœê·¸ ì—…ë°ì´íŠ¸
    function updateFilterTags() {
      const filterTags = document.getElementById('filterTags');
      let html = '';

      if (currentSearch) {
        html += `<div class="filter-tag">ê²€ìƒ‰: ${currentSearch} <span class="remove" onclick="removeSearchFilter()">Ã—</span></div>`;
      }

      if (currentSector !== 'all') {
        html += `<div class="filter-tag">ì„¹í„°: ${sectors[currentSector].name} <span class="remove" onclick="removeSectorFilter()">Ã—</span></div>`;
      }

      filterTags.innerHTML = html;
    }

    function removeSearchFilter() {
      currentSearch = '';
      document.getElementById('searchInput').value = '';
      loadNews();
      updateFilterTags();
    }

    function removeSectorFilter() {
      selectSector('all');
      document.getElementById('sectorFilter').value = 'all';
      updateFilterTags();
    }

    // í•„í„° ì´ˆê¸°í™”
    function resetFilters() {
      currentSearch = '';
      currentSector = 'all';
      document.getElementById('searchInput').value = '';
      document.getElementById('sectorFilter').value = 'all';
      document.getElementById('timeFilter').value = 'today';
      selectSector('all');
      updateFilterTags();
    }

    // ìƒˆë¡œê³ ì¹¨
    function refreshNews() {
      loadNews();
    }

    // ê²€ìƒ‰ ì…ë ¥ ì—”í„°í‚¤
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchNews();
      }
    });

    // ì´ˆê¸° ë¡œë“œ
    (async () => {
      await applyCustomStocksFromStorage();
      rebuildAllStocks(); // ì´ˆê¸°í™” ì‹œ ì´ ì¢…ëª© ìˆ˜ ì—…ë°ì´íŠ¸
      renderSectorList();
      // ê¸°ì¡´ì— í‘œì‹œëœ ëª¨ë“  ë‰´ìŠ¤ ì‚­ì œ
      clearAllNews();
      loadNews();
    })();

    // ìë™ ìƒˆë¡œê³ ì¹¨ (10ë¶„ë§ˆë‹¤)
    setInterval(refreshNews, 10 * 60 * 1000);
    
    // ì˜¤ë˜ëœ ë‰´ìŠ¤ ì •ë¦¬ (10ë¶„ë§ˆë‹¤)
    setInterval(() => {
      const storedNews = loadStoredNews();
      saveStoredNews(storedNews); // 48ì‹œê°„ ì´ìƒ ëœ ë‰´ìŠ¤ ìë™ ì‚­ì œ
    }, 10 * 60 * 1000);
  </script>
</body>
</html>